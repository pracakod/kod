<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Lista ‚Ä¢ Zadania, Zakupy i Przypomnienia</title>
<meta name="color-scheme" content="light dark" />
<style>
  /* DODANE STYLE DLA NOWYCH FUNKCJONALNO≈öCI */
  
  /* Sekcje i chipy nawigacji */
  .section-tabs {
    display: flex;
    gap: 8px;
    padding: 0 16px 12px;
    border-bottom: 1px solid var(--border);
    margin-bottom: 12px;
    overflow-x: auto;
  }
  .section-chip {
    padding: 8px 16px;
    border-radius: 20px;
    border: 1px solid var(--border);
    background: var(--card);
    font-size: 14px;
    font-weight: 500;
    white-space: nowrap;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  .section-chip.active {
    background: var(--accent);
    color: white;
    border-color: var(--accent);
  }
  
  /* Akordeon w menu */
  .menu-accordion {
    margin: 8px 0;
  }
  .accordion-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px;
    font-weight: 600;
    cursor: pointer;
    border-radius: 8px;
  }
  .accordion-header:hover {
    background: color-mix(in oklab, var(--card) 92%, var(--accent) 8%);
  }
  .accordion-content {
    padding-left: 20px;
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease;
  }
  .accordion-content.open {
    max-height: 500px;
  }
  
  /* Specyficzne style dla sekcji */
  .shopping-item {
    position: relative;
  }
  .item-details {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-top: 4px;
    flex-wrap: wrap;
  }
  .quantity-controls {
    display: flex;
    align-items: center;
    gap: 4px;
    background: var(--accent-soft);
    border-radius: 8px;
    padding: 2px 6px;
  }
  .qty-btn {
    width: 24px;
    height: 24px;
    border-radius: 6px;
    border: 1px solid var(--border);
    background: var(--card);
    display: grid;
    place-items: center;
    font-size: 14px;
    font-weight: bold;
  }
  .item-chip {
    font-size: 11px;
    padding: 2px 6px;
    border-radius: 10px;
    background: var(--accent-soft);
    color: var(--accent);
    white-space: nowrap;
  }
  .price {
    font-weight: 600;
    color: var(--text);
  }
  
  /* Dolny pasek dynamiczny */
  .bottom-bar-content {
    display: flex;
    align-items: center;
    gap: 12px;
    flex: 1;
    justify-content: space-between;
    padding: 0 8px;
  }
  .store-filter, .group-filter {
    padding: 6px 12px;
    border-radius: 12px;
    border: 1px solid var(--border);
    background: var(--card);
    font-size: 14px;
    cursor: pointer;
  }
  .store-filter.active, .group-filter.active {
    background: var(--accent);
    color: white;
    border-color: var(--accent);
  }
  .total-sum {
    font-weight: 600;
    font-size: 15px;
  }
  
  /* Filtry dla zada≈Ñ */
  .task-filters {
    display: flex;
    gap: 8px;
    padding: 0 16px 12px;
    overflow-x: auto;
  }
  .filter-chip {
    padding: 6px 12px;
    border-radius: 16px;
    border: 1px solid var(--border);
    background: var(--card);
    font-size: 13px;
    white-space: nowrap;
    cursor: pointer;
  }
  .filter-chip.active {
    background: var(--accent);
    color: white;
    border-color: var(--accent);
  }
  
  /* Szybkie chipy sugerowanych produkt√≥w */
  .suggested-chips {
    display: flex;
    gap: 8px;
    padding: 8px 16px;
    overflow-x: auto;
    border-bottom: 1px solid var(--border);
  }
  .suggested-chip {
    padding: 6px 12px;
    border-radius: 16px;
    border: 1px solid var(--border);
    background: var(--card);
    font-size: 13px;
    white-space: nowrap;
    cursor: pointer;
  }
  
  /* Priorytety zada≈Ñ */
  .priority-chip {
    font-size: 11px;
    padding: 2px 6px;
    border-radius: 10px;
    font-weight: 600;
  }
  .priority-low { background: #e8f5e8; color: #2ecc71; }
  .priority-med { background: #fff3cd; color: #f39c12; }
  .priority-high { background: #fde8e8; color: #e74c3c; }
  
  /* Przypomnienia */
  .reminder-time {
    font-size: 12px;
    color: var(--muted);
  }
  .snooze-btn {
    padding: 4px 8px;
    border-radius: 8px;
    border: 1px solid var(--border);
    background: var(--card);
    font-size: 12px;
    cursor: pointer;
  }

  /* Animacja pulsowania dla przypomnie≈Ñ */
  @keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(74, 144, 226, 0.7); }
    70% { box-shadow: 0 0 0 10px rgba(74, 144, 226, 0); }
    100% { box-shadow: 0 0 0 0 rgba(74, 144, 226, 0); }
  }
  .item.reminder-active {
    animation: pulse 2s infinite;
  }
</style>

<!-- Reszta istniejƒÖcego CSS pozostaje bez zmian -->
<!-- ... -->

</head>
<body>
<div class="app" id="app">
  <header class="app-header">
    <!-- Sekcje i chipy nawigacji -->
    <div class="section-tabs" id="sectionTabs">
      <div class="section-chip active" data-section="tasks">Zadania ‚úÖ</div>
      <div class="section-chip" data-section="shopping">Zakupy üõí</div>
      <div class="section-chip" data-section="reminders">Przypomnienia ‚è∞</div>
    </div>
    
    <button class="title-button" id="openMenuBtn" aria-haspopup="true" aria-expanded="false">
      <span class="dot" id="listDot"></span>
      <span class="list-icon" id="currentListIcon" hidden></span>
      <span class="title-text" id="currentListName">Moja lista</span>
      <svg class="caret" viewBox="0 0 24 24" fill="none" aria-hidden="true">
        <path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>

    <div class="dropdown" id="listMenu" role="menu" aria-label="Wybierz listƒô">
      <!-- Menu z akordeonami grupujƒÖcymi listy wed≈Çug sekcji -->
      <div class="menu-accordion" id="tasksAccordion">
        <div class="accordion-header" data-section="tasks">
          <span>Zadania ‚úÖ</span>
          <svg width="16" height="16" viewBox="0 0 24 24" class="accordion-arrow">
            <path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
        <div class="accordion-content" id="tasksLists"></div>
      </div>
      
      <div class="menu-accordion" id="shoppingAccordion">
        <div class="accordion-header" data-section="shopping">
          <span>Zakupy üõí</span>
          <svg width="16" height="16" viewBox="0 0 24 24" class="accordion-arrow">
            <path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
        <div class="accordion-content" id="shoppingLists"></div>
      </div>
      
      <div class="menu-accordion" id="remindersAccordion">
        <div class="accordion-header" data-section="reminders">
          <span>Przypomnienia ‚è∞</span>
          <svg width="16" height="16" viewBox="0 0 24 24" class="accordion-arrow">
            <path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
        <div class="accordion-content" id="remindersLists"></div>
      </div>
      
      <!-- Reszta menu pozostaje -->
      <div class="menu-sec">
        <button class="menu-item" id="completedViewBtn">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
            <path d="M20 12a8 8 0 11-16 0 8 8 0 0116 0z" stroke="currentColor" stroke-width="2"/>
            <path d="M9 12l2 2 4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <span class="name">Zako≈Ñczone</span>
          <span class="tick" aria-hidden="true">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M5 12l4 4 10-10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
          </span>
        </button>
      </div>
      
      <div class="menu-sec">
        <button class="menu-item" id="manageListBtn">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
            <path d="M12 15a3 3 0 100-6 3 3 0 000 6z" stroke="currentColor" stroke-width="2"/>
            <path d="M19.5 12a7.5 7.5 0 10-15 0 7.5 7.5 0 0015 0z" stroke="currentColor" stroke-width="1.4" opacity=".4"/>
          </svg>
          <span class="name">ZarzƒÖdzaj listƒÖ</span>
        </button>
        <button class="menu-item" id="addListBtn">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
            <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
          <span class="name">Nowa lista</span>
        </button>
      </div>
    </div>
  </header>

  <main>
    <!-- Szybkie chipy sugerowanych produkt√≥w (tylko dla zakup√≥w) -->
    <div class="suggested-chips" id="suggestedChips" hidden></div>
    
    <!-- Filtry zada≈Ñ -->
    <div class="task-filters" id="taskFilters" hidden>
      <div class="filter-chip active" data-filter="all">Wszystkie</div>
      <div class="filter-chip" data-filter="today">Dzi≈õ</div>
      <div class="filter-chip" data-filter="upcoming">NadchodzƒÖce</div>
      <div class="filter-chip" data-filter="important">Wa≈ºne</div>
    </div>
    
    <div id="listContainer" class="list"></div>
    <div id="emptyState" class="empty" hidden>Brak pozycji.</div>
  </main>

  <nav class="bottom-nav">
    <div class="bottom-bar-content" id="bottomBarContent">
      <!-- Zawarto≈õƒá dolnego paska bƒôdzie dynamicznie zmieniana w zale≈ºno≈õci od sekcji -->
      <div class="nav-left" id="dynamicNavLeft"></div>
      
      <button class="fab" id="addBtn" aria-label="Dodaj">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
          <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>
      
      <div class="nav-right" id="dynamicNavRight"></div>
    </div>
  </nav>

  <!-- Reszta istniejƒÖcego HTML pozostaje -->
  <!-- ... -->

  <!-- NOWE DIALOGI DLA SPECJALNYCH FUNKCJI -->

  <!-- Dialog dodawania zakup√≥w z parserem -->
  <dialog id="shoppingDialog">
    <form id="shoppingForm">
      <div class="dlg-head">
        <div class="dlg-title">Dodaj produkt</div>
        <button class="btn" type="button" id="shoppingDlgClose">Zamknij</button>
      </div>
      <div class="dlg-body">
        <div class="field">
          <div class="label">Nazwa produktu</div>
          <input type="text" id="shoppingText" placeholder="np. mleko 2x @lidl" required />
          <div class="hint">Sk≈Çadnia: nazwa [ilo≈õƒá][jednostka] [cena] [#kategoria] [@sklep]</div>
        </div>
        <div class="row">
          <div class="field grow">
            <div class="label">Ilo≈õƒá</div>
            <input type="number" id="shoppingQty" step="0.1" min="0" value="1" />
          </div>
          <div class="field">
            <div class="label">Jednostka</div>
            <select id="shoppingUnit">
              <option value="">szt.</option>
              <option value="kg">kg</option>
              <option value="g">g</option>
              <option value="l">l</option>
              <option value="ml">ml</option>
              <option value="op">op.</option>
            </select>
          </div>
        </div>
        <div class="field">
          <div class="label">Cena (opcjonalnie)</div>
          <input type="number" id="shoppingPrice" step="0.01" min="0" placeholder="0.00" />
        </div>
        <div class="row">
          <div class="field grow">
            <div class="label">Kategoria</div>
            <select id="shoppingCategory">
              <option value="">Wybierz kategoriƒô</option>
              <option value="Warzywa i owoce">Warzywa i owoce</option>
              <option value="Nabia≈Ç">Nabia≈Ç</option>
              <option value="Pieczywo">Pieczywo</option>
              <option value="Miƒôso">Miƒôso</option>
              <option value="Mro≈ºonki">Mro≈ºonki</option>
              <option value="Napoje">Napoje</option>
              <option value="S≈Çodycze">S≈Çodycze</option>
              <option value="Chemia">Chemia</option>
              <option value="Inne">Inne</option>
            </select>
          </div>
          <div class="field grow">
            <div class="label">Sklep</div>
            <select id="shoppingStore">
              <option value="">Wybierz sklep</option>
              <option value="Biedronka">Biedronka</option>
              <option value="Lidl">Lidl</option>
              <option value="Kaufland">Kaufland</option>
              <option value="Aldi">Aldi</option>
              <option value="Netto">Netto</option>
              <option value="Carrefour">Carrefour</option>
              <option value="Auchan">Auchan</option>
              <option value="≈ªabka">≈ªabka</option>
              <option value="Inny">Inny</option>
            </select>
          </div>
        </div>
      </div>
      <div class="dlg-foot">
        <button class="btn" type="button" id="shoppingDlgCancel">Anuluj</button>
        <button class="btn primary" type="submit">Dodaj</button>
      </div>
    </form>
  </dialog>

  <!-- Dialog dodawania zada≈Ñ -->
  <dialog id="taskDialog">
    <form id="taskForm">
      <div class="dlg-head">
        <div class="dlg-title">Dodaj zadanie</div>
        <button class="btn" type="button" id="taskDlgClose">Zamknij</button>
      </div>
      <div class="dlg-body">
        <div class="field">
          <div class="label">Zadanie</div>
          <input type="text" id="taskText" placeholder="np. Zrobiƒá pranie" required />
        </div>
        <div class="row">
          <div class="field grow">
            <div class="label">Termin</div>
            <input type="date" id="taskDue" />
          </div>
          <div class="field">
            <div class="label">Priorytet</div>
            <select id="taskPriority">
              <option value="low">Niski</option>
              <option value="med" selected>≈öredni</option>
              <option value="high">Wysoki</option>
            </select>
          </div>
        </div>
      </div>
      <div class="dlg-foot">
        <button class="btn" type="button" id="taskDlgCancel">Anuluj</button>
        <button class="btn primary" type="submit">Dodaj</button>
      </div>
    </form>
  </dialog>

  <!-- Dialog dodawania przypomnie≈Ñ -->
  <dialog id="reminderDialog">
    <form id="reminderForm">
      <div class="dlg-head">
        <div class="dlg-title">Dodaj przypomnienie</div>
        <button class="btn" type="button" id="reminderDlgClose">Zamknij</button>
      </div>
      <div class="dlg-body">
        <div class="field">
          <div class="label">Przypomnienie</div>
          <input type="text" id="reminderText" placeholder="np. Zadzwoniƒá do lekarza" required />
        </div>
        <div class="row">
          <div class="field grow">
            <div class="label">Data i godzina</div>
            <input type="datetime-local" id="reminderTime" required />
          </div>
          <div class="field">
            <div class="label">Powtarzanie</div>
            <select id="reminderRepeat">
              <option value="none">Nie powtarzaj</option>
              <option value="daily">Codziennie</option>
              <option value="weekly">Co tydzie≈Ñ</option>
              <option value="monthly">Co miesiƒÖc</option>
              <option value="yearly">Co rok</option>
            </select>
          </div>
        </div>
      </div>
      <div class="dlg-foot">
        <button class="btn" type="button" id="reminderDlgCancel">Anuluj</button>
        <button class="btn primary" type="submit">Dodaj</button>
      </div>
    </form>
  </dialog>

</div>

<script>
(()=>{'use strict';
  // NAJPIERW ZDEFINIOWAƒÜ PODSTAWOWY STAN, POTEM GO ROZSZERZYƒÜ
  const LS_KEY = 'todoAppData_v9';
  
  // Podstawowy stan (oryginalny)
  const state = {
    lists: [],
    settings: { dark:false, hideCompleted:false, vibrate:true },
    currentListId: null,
    lastActiveListId: null,
    editMode: false,
  };

  // Rozszerzony stan
  const extendedState = {
    ...state, // Kopiuj podstawowy stan
    currentSection: 'tasks',
    activeStore: '',
    groupBy: 'category',
    shoppingSettings: { showPrices: true, defaultGrouping: 'category' },
    taskFilter: 'all',
    reminderRange: 'today',
    suggestedProducts: []
  };

  // Zachowaj oryginalne funkcje pomocnicze
  const el = (id) => document.getElementById(id);
  const $ = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

  const PALETTE10 = ['#4a90e2','#E86B27','#2ecc71','#9b59b6','#e74c3c','#f39c12','#16a085','#d35400','#27ae60','#8e44ad'];
  const ICONS = ['üõí','üçé','ü•¶','üì¶','üè†','üéÅ','üßπ','üí°','üìö','üíº','‚öΩÔ∏è','üéµ','üçΩÔ∏è','üß™','üéØ'];
  const NAME_MAX = 40;

  function uid(prefix='id'){ return `${prefix}_${Math.random().toString(36).slice(2,7)}_${Date.now().toString(36)}`; }
  
  function defaultData(){
    const list1 = { 
      id: uid('list'), 
      name: 'Zadania domowe', 
      color: '#4a90e2', 
      icon: '', 
      type: 'tasks',
      items: [] 
    };
    const list2 = { 
      id: uid('list'), 
      name: 'Lista zakup√≥w', 
      color: '#E86B27', 
      icon: 'üõí', 
      type: 'shopping',
      items: [] 
    };
    const list3 = { 
      id: uid('list'), 
      name: 'Przypomnienia', 
      color: '#2ecc71', 
      icon: '‚è∞', 
      type: 'reminders',
      items: [] 
    };
    
    return { 
      lists: [list1, list2, list3], 
      settings: { dark:false, hideCompleted:false, vibrate:true }, 
      currentListId: list1.id, 
      lastActiveListId: list1.id, 
      editMode: false,
      // Rozszerzone pola
      currentSection: 'tasks',
      activeStore: '',
      groupBy: 'category',
      shoppingSettings: { showPrices: true, defaultGrouping: 'category' },
      taskFilter: 'all',
      reminderRange: 'today',
      suggestedProducts: []
    };
  }

  function migrateData(){
    extendedState.lists.forEach(l=>{
      if(typeof l.icon !== 'string') l.icon = '';
      if(!Array.isArray(l.items)) l.items = [];
      if(!l.type) l.type = 'tasks'; // Migracja starych list
      
      l.items.forEach(it=>{
        if(typeof it.completedAt === 'undefined') it.completedAt = it.done ? Date.now() : null;
        // Rozszerz struktury pozycji
        extendItemStructure(it, l.type);
      });
    });
  }

  function save(){
    const dataToSave = {
      lists: extendedState.lists,
      settings: extendedState.settings,
      currentListId: extendedState.currentListId,
      lastActiveListId: extendedState.lastActiveListId,
      // Rozszerzone pola
      currentSection: extendedState.currentSection,
      activeStore: extendedState.activeStore,
      groupBy: extendedState.groupBy,
      shoppingSettings: extendedState.shoppingSettings,
      taskFilter: extendedState.taskFilter,
      reminderRange: extendedState.reminderRange,
      suggestedProducts: extendedState.suggestedProducts
    };
    localStorage.setItem(LS_KEY, JSON.stringify(dataToSave));
  }

  function load(){
    const raw = localStorage.getItem(LS_KEY);
    if(!raw){ 
      Object.assign(extendedState, defaultData()); 
      return; 
    }
    try{
      const data = JSON.parse(raw);
      Object.assign(extendedState, defaultData(), data);
      if(!Array.isArray(extendedState.lists) || extendedState.lists.length === 0){
        const d = defaultData();
        extendedState.lists = d.lists; 
        extendedState.currentListId = d.currentListId; 
        extendedState.lastActiveListId = d.lastActiveListId;
      }
    }catch{ 
      Object.assign(extendedState, defaultData()); 
    }
  }

  // Dynamiczny akcent + neon gradient z koloru listy
  function setTheme(dark){
    extendedState.settings.dark = !!dark;
    document.documentElement.setAttribute('data-theme', extendedState.settings.dark ? 'dark' : 'light');
  }
  
  function setAccent(color){
    document.documentElement.style.setProperty('--accent', color);
    document.documentElement.style.setProperty('--accent-soft', hexToRgba(color, 0.14));
    const {neo1, neo2} = deriveNeoGradient(color);
    document.documentElement.style.setProperty('--neo1', neo1);
    document.documentElement.style.setProperty('--neo2', neo2);
  }

  function hexToRgba(hex, a=1){
    let h = hex.replace('#',''); if(h.length===3){ h = h.split('').map(c=>c+c).join(''); }
    const r = parseInt(h.slice(0,2),16), g = parseInt(h.slice(2,4),16), b = parseInt(h.slice(4,6),16);
    return `rgba(${r},${g},${b},${a})`;
  }
  
  function hexToRgb(hex){
    let h = hex.replace('#',''); if(h.length===3){ h = h.split('').map(c=>c+c).join(''); }
    const r = parseInt(h.slice(0,2),16), g = parseInt(h.slice(2,4),16), b = parseInt(h.slice(4,6),16);
    return {r,g,b};
  }
  
  function rgbToHsl(r,g,b){
    r/=255; g/=255; b/=255;
    const max=Math.max(r,g,b), min=Math.min(r,g,b);
    let h,s,l=(max+min)/2;
    if(max===min){ h=s=0; }
    else{
      const d=max-min;
      s=l>0.5? d/(2-max-min) : d/(max+min);
      switch(max){
        case r: h=(g-b)/d + (g<b?6:0); break;
        case g: h=(b-r)/d + 2; break;
        case b: h=(r-g)/d + 4; break;
      }
      h*=60;
    }
    return {h, s:s*100, l:l*100};
  }
  
  function hslToHexSafe(h,s,l){
    s/=100; l/=100;
    const c=(1-Math.abs(2*l-1))*s;
    const hh=h/60;
    const x=c*(1-Math.abs(hh%2-1));
    let r=0,g=0,b=0;
    if(hh>=0 && hh<1){ r=c; g=x; b=0; }
    else if(hh>=1 && hh<2){ r=x; g=c; b=0; }
    else if(hh>=2 && hh<3){ r=0; g=c; b=x; }
    else if(hh>=3 && hh<4){ r=0; g=x; b=c; }
    else if(hh>=4 && hh<5){ r=x; g=0; b=c; }
    else { r=c; g=0; b=x; }
    const m=l-c/2;
    r=Math.round((r+m)*255); g=Math.round((g+m)*255); b=Math.round((b+m)*255);
    return '#'+[r,g,b].map(v=> v.toString(16).padStart(2,'0')).join('');
  }
  
  function clamp(v,min,max){ return Math.min(max, Math.max(min, v)); }
  
  function deriveNeoGradient(accent){
    const {r,g,b} = hexToRgb(accent);
    const {h,s,l} = rgbToHsl(r,g,b);
    const neo1 = hslToHexSafe((h+10)%360, clamp(s+10,0,100), clamp(l+6,0,100));
    const neo2 = hslToHexSafe((h-14+360)%360, clamp(s+22,0,100), clamp(l-8,0,100));
    return {neo1, neo2};
  }

  function vibrate(ms=20){ 
    if(!extendedState.settings.vibrate) return; 
    if('vibrate' in navigator){ 
      try{ navigator.vibrate(ms); }catch{} 
    } 
  }
  
  function currentList(){ 
    if(extendedState.currentListId === '__completed__') return null; 
    const list = extendedState.lists.find(l => l.id === extendedState.currentListId) || extendedState.lists[0];
    // Zwr√≥ƒá listƒô tylko je≈õli pasuje do bie≈ºƒÖcej sekcji
    return list && list.type === extendedState.currentSection ? list : null;
  }
  
  function listById(id){ return extendedState.lists.find(l => l.id === id); }
  
  function escapeHtml(str=''){ return str.replace(/[&<>"']/g, s=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[s])); }

  // Rozszerzenie struktury pozycji
  function extendItemStructure(item, type = 'tasks') {
    if (type === 'shopping') {
      item.qty = item.qty || 1;
      item.unit = item.unit || '';
      item.price = item.price || 0;
      item.category = item.category || '';
      item.store = item.store || '';
    } else if (type === 'tasks') {
      item.due = item.due || null;
      item.priority = item.priority || 'med';
    } else if (type === 'reminders') {
      item.remindAt = item.remindAt || null;
      item.repeat = item.repeat || 'none';
    }
    return item;
  }

  // Parser dla szybkiego dodawania zakup√≥w
  function parseShoppingInput(text) {
    const result = {
      text: text,
      qty: 1,
      unit: '',
      price: 0,
      category: '',
      store: ''
    };
    
    const patterns = [
      { regex: /(\d+\.?\d*)\s*(kg|g|l|ml|szt|op)\b/i, handler: (match) => {
        result.qty = parseFloat(match[1]);
        result.unit = match[2].toLowerCase();
      }},
      { regex: /(\d+)\s*x\s*/i, handler: (match) => {
        result.qty = parseInt(match[1]);
      }},
      { regex: /(\d+[,.]?\d*)\s*(z≈Ç|pln)?\b/i, handler: (match) => {
        result.price = parseFloat(match[1].replace(',', '.'));
      }},
      { regex: /#(\w+)/i, handler: (match) => {
        result.category = match[1];
      }},
      { regex: /@(\w+)/i, handler: (match) => {
        result.store = match[1];
      }}
    ];
    
    let processedText = text;
    patterns.forEach(pattern => {
      const match = processedText.match(pattern.regex);
      if (match) {
        pattern.handler(match);
        processedText = processedText.replace(match[0], '');
      }
    });
    
    result.text = processedText
      .replace(/[#@]\w+/g, '')
      .replace(/\d+[,.]?\d*\s*(z≈Ç|pln|kg|g|l|ml|szt|op|x)?/gi, '')
      .trim()
      .replace(/\s+/g, ' ')
      .replace(/,$/, '');
    
    return result;
  }

  // Renderowanie sekcji i nawigacji
  function renderSectionNavigation() {
    const sectionTabs = el('sectionTabs');
    sectionTabs.innerHTML = '';
    
    ['tasks', 'shopping', 'reminders'].forEach(section => {
      const chip = document.createElement('div');
      chip.className = `section-chip ${extendedState.currentSection === section ? 'active' : ''}`;
      chip.dataset.section = section;
      
      switch(section) {
        case 'tasks': chip.textContent = 'Zadania ‚úÖ'; break;
        case 'shopping': chip.textContent = 'Zakupy üõí'; break;
        case 'reminders': chip.textContent = 'Przypomnienia ‚è∞'; break;
      }
      
      chip.addEventListener('click', () => {
        extendedState.currentSection = section;
        const sectionList = extendedState.lists.find(l => l.type === section);
        if (sectionList) {
          extendedState.currentListId = sectionList.id;
          extendedState.lastActiveListId = sectionList.id;
        }
        save();
        render();
      });
      
      sectionTabs.appendChild(chip);
    });
  }

  // Renderowanie menu z akordeonami
  function renderAccordionMenu() {
    renderSectionAccordion('tasks', el('tasksLists'));
    renderSectionAccordion('shopping', el('shoppingLists')); 
    renderSectionAccordion('reminders', el('remindersLists'));
    
    $$('.accordion-header').forEach(header => {
      header.addEventListener('click', () => {
        const content = header.nextElementSibling;
        content.classList.toggle('open');
        const arrow = header.querySelector('.accordion-arrow');
        arrow.style.transform = content.classList.contains('open') ? 'rotate(180deg)' : 'rotate(0)';
      });
    });
  }

  function renderSectionAccordion(section, container) {
    container.innerHTML = '';
    const sectionLists = extendedState.lists.filter(l => l.type === section);
    
    sectionLists.forEach(list => {
      const btn = document.createElement('div');
      btn.className = 'menu-item';
      btn.dataset.id = list.id;
      btn.innerHTML = `
        <span class="grip" aria-hidden="true">
          <svg width="16" height="16" viewBox="0 0 24 24"><path d="M9 6h6M9 12h6M9 18h6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        </span>
        <span class="color-dot" style="background:${list.color}"></span>
        ${list.icon ? `<span class="list-icon" aria-hidden="true">${escapeHtml(list.icon)}</span>` : ''}
        <span class="name">${escapeHtml(list.name)}</span>
        <span class="pill">${list.items.filter(i=>!i.done).length}</span>
        <span class="tick" aria-hidden="true">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M5 12l4 4 10-10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </span>
      `;
      
      const isActive = extendedState.currentListId === list.id;
      btn.classList.toggle('is-active', isActive);
      
      btn.addEventListener('click', () => {
        extendedState.currentListId = list.id;
        extendedState.lastActiveListId = list.id;
        closeMenu();
        save();
        render();
      });
      
      container.appendChild(btn);
    });
    
    const activeInSection = sectionLists.some(l => l.id === extendedState.currentListId);
    if (activeInSection) {
      container.classList.add('open');
      const arrow = container.previousElementSibling.querySelector('.accordion-arrow');
      if (arrow) arrow.style.transform = 'rotate(180deg)';
    }
  }

  // Renderowanie dynamicznego dolnego paska
  function renderDynamicBottomBar() {
    const navLeft = el('dynamicNavLeft');
    const navRight = el('dynamicNavRight');
    
    navLeft.innerHTML = '';
    navRight.innerHTML = '';
    
    switch(extendedState.currentSection) {
      case 'shopping':
        renderShoppingBottomBar(navLeft, navRight);
        break;
      case 'tasks':
        renderTasksBottomBar(navLeft, navRight);
        break;
      case 'reminders':
        renderRemindersBottomBar(navLeft, navRight);
        break;
    }
  }

  function renderShoppingBottomBar(navLeft, navRight) {
    const storeFilter = document.createElement('select');
    storeFilter.className = 'store-filter';
    storeFilter.innerHTML = `
      <option value="">Wszystkie sklepy</option>
      <option value="Biedronka">Biedronka</option>
      <option value="Lidl">Lidl</option>
      <option value="Kaufland">Kaufland</option>
      <option value="Aldi">Aldi</option>
      <option value="Netto">Netto</option>
      <option value="Carrefour">Carrefour</option>
      <option value="Auchan">Auchan</option>
      <option value="≈ªabka">≈ªabka</option>
      <option value="Inny">Inny</option>
    `;
    storeFilter.value = extendedState.activeStore;
    storeFilter.addEventListener('change', (e) => {
      extendedState.activeStore = e.target.value;
      save();
      render();
    });
    navLeft.appendChild(storeFilter);
    
    const groupFilter = document.createElement('select');
    groupFilter.className = 'group-filter';
    groupFilter.innerHTML = `
      <option value="category">Kategoria</option>
      <option value="store">Sklep</option>
    `;
    groupFilter.value = extendedState.groupBy;
    groupFilter.addEventListener('change', (e) => {
      extendedState.groupBy = e.target.value;
      save();
      render();
    });
    navRight.appendChild(groupFilter);
    
    const currentList = currentList();
    if (currentList) {
      const items = currentList.items.filter(i => !i.done);
      const total = items.reduce((sum, item) => sum + (item.price || 0) * (item.qty || 1), 0);
      const totalEl = document.createElement('div');
      totalEl.className = 'total-sum';
      totalEl.textContent = total > 0 ? `${total.toFixed(2)} z≈Ç` : `${items.length} pozycji`;
      navRight.appendChild(totalEl);
      
      if (items.length > 0) {
        const resetBtn = document.createElement('button');
        resetBtn.className = 'icon-btn';
        resetBtn.innerHTML = `<svg width="18" height="18" viewBox="0 0 24 24"><path d="M3 12a9 9 0 1018 0 9 9 0 00-18 0z" stroke="currentColor" stroke-width="2"/><path d="M9 12l2 2 4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
        resetBtn.title = 'Kup to samo';
        resetBtn.addEventListener('click', () => {
          currentList.items.forEach(item => item.done = false);
          save();
          render();
        });
        navRight.appendChild(resetBtn);
      }
    }
  }

  function renderTasksBottomBar(navLeft, navRight) {
    ['all', 'today', 'upcoming', 'important'].forEach(filter => {
      const chip = document.createElement('button');
      chip.className = `filter-chip ${extendedState.taskFilter === filter ? 'active' : ''}`;
      chip.dataset.filter = filter;
      chip.textContent = 
        filter === 'all' ? 'Wszystkie' :
        filter === 'today' ? 'Dzi≈õ' :
        filter === 'upcoming' ? 'NadchodzƒÖce' :
        'Wa≈ºne';
      
      chip.addEventListener('click', () => {
        extendedState.taskFilter = filter;
        save();
        render();
      });
      
      navLeft.appendChild(chip);
    });
  }

  function renderRemindersBottomBar(navLeft, navRight) {
    const rangeSelect = document.createElement('select');
    rangeSelect.className = 'store-filter';
    rangeSelect.innerHTML = `
      <option value="today">Dzi≈õ</option>
      <option value="upcoming">NadchodzƒÖce</option>
    `;
    rangeSelect.value = extendedState.reminderRange;
    rangeSelect.addEventListener('change', (e) => {
      extendedState.reminderRange = e.target.value;
      save();
      render();
    });
    navLeft.appendChild(rangeSelect);
    
    const snoozeBtn = document.createElement('button');
    snoozeBtn.className = 'icon-btn';
    snoozeBtn.innerHTML = `<svg width="18" height="18" viewBox="0 0 24 24"><path d="M12 6v6l4 2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="2"/></svg>`;
    snoozeBtn.title = 'Odr√≥ƒá wszystkie 10 min';
    snoozeBtn.addEventListener('click', () => {
      const currentList = currentList();
      if (currentList) {
        const now = Date.now();
        currentList.items.forEach(item => {
          if (item.remindAt && item.remindAt <= now && !item.done) {
            item.remindAt = now + 10 * 60 * 1000;
          }
        });
        save();
        render();
      }
    });
    navRight.appendChild(snoozeBtn);
  }

  // G≈Ç√≥wne renderowanie
  function render(){
    document.body.classList.toggle('edit-on', !!extendedState.editMode);
    const isCompletedView = extendedState.currentListId === '__completed__';
    const cl = currentList();
    const accent = isCompletedView ? '#7a7f8c' : (cl?.color || '#4a90e2');
    setAccent(accent);
    
    el('currentListName').textContent = isCompletedView ? 'Zako≈Ñczone' : (cl?.name || 'Lista');
    el('listDot').style.background = accent;
    el('listDot').style.boxShadow = `0 0 0 3px ${hexToRgba(accent, .18)}`;

    const iconEl = el('currentListIcon');
    if(!isCompletedView && cl?.icon){
      iconEl.textContent = cl.icon;
      iconEl.hidden = false;
    }else{
      iconEl.hidden = true;
      iconEl.textContent = '';
    }

    el('addBtn').classList.toggle('disabled', isCompletedView);
    el('quickAddBtn').classList.toggle('disabled', isCompletedView);
    if(isCompletedView) closeQuick();

    renderSectionNavigation();
    renderAccordionMenu();
    renderDynamicBottomBar();
    renderExtendedItems();

    el('darkModeToggle').checked = !!extendedState.settings.dark;
    el('hideCompletedToggle').checked = !!extendedState.settings.hideCompleted;
    el('vibrateToggle').checked = !!extendedState.settings.vibrate;

    el('editModeBtn').classList.toggle('active', !!extendedState.editMode);
  }

  // Renderowanie rozszerzonych pozycji
  function renderExtendedItems() {
    const container = el('listContainer');
    container.innerHTML = '';
    
    el('suggestedChips').hidden = extendedState.currentSection !== 'shopping';
    el('taskFilters').hidden = extendedState.currentSection !== 'tasks';
    
    if (extendedState.currentSection === 'shopping') {
      renderSuggestedChips();
    }
    
    const isCompletedView = extendedState.currentListId === '__completed__';
    let items = [], lref = null;
    
    if (isCompletedView) {
      extendedState.lists.forEach(l => 
        l.items.forEach(it => { 
          if (it.done) items.push({...it, __fromList: l.id, __fromSection: l.type});
        })
      );
      items.sort((a,b) => (b.completedAt||0) - (a.completedAt||0));
    } else {
      lref = currentList();
      if (!lref) return;
      
      let filteredItems = lref.items.filter(i => 
        extendedState.currentSection === 'shopping' ? true : !i.done
      );
      
      if (extendedState.currentSection === 'tasks') {
        const now = new Date();
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const tomorrow = new Date(today);
        tomorrow.setDate(tomorrow.getDate() + 1);
        const weekEnd = new Date(today);
        weekEnd.setDate(weekEnd.getDate() + 7);
        
        filteredItems = filteredItems.filter(item => {
          if (!item.due) return extendedState.taskFilter === 'all';
          
          const dueDate = new Date(item.due);
          switch(extendedState.taskFilter) {
            case 'today':
              return dueDate.toDateString() === today.toDateString();
            case 'upcoming':
              return dueDate >= today && dueDate <= weekEnd;
            case 'important':
              return item.priority === 'high';
            default:
              return true;
          }
        });
        
        filteredItems.sort((a, b) => {
          if (a.due && b.due) {
            return new Date(a.due) - new Date(b.due);
          }
          if (a.due && !b.due) return -1;
          if (!a.due && b.due) return 1;
          
          const priorityOrder = { high: 0, med: 1, low: 2 };
          return priorityOrder[a.priority] - priorityOrder[b.priority];
        });
      }
      
      if (extendedState.currentSection === 'reminders') {
        const now = new Date();
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const tomorrow = new Date(today);
        tomorrow.setDate(tomorrow.getDate() + 1);
        
        filteredItems = filteredItems.filter(item => {
          if (!item.remindAt) return true;
          
          const remindDate = new Date(item.remindAt);
          if (extendedState.reminderRange === 'today') {
            return remindDate.toDateString() === today.toDateString();
          } else {
            return remindDate >= today;
          }
        });
        
        filteredItems.sort((a, b) => {
          if (a.remindAt && b.remindAt) {
            return new Date(a.remindAt) - new Date(b.remindAt);
          }
          if (a.remindAt && !b.remindAt) return -1;
          if (!a.remindAt && b.remindAt) return 1;
          return 0;
        });
      }
      
      if (extendedState.currentSection === 'shopping' && extendedState.groupBy) {
        const groups = {};
        filteredItems.forEach(item => {
          const groupKey = item[extendedState.groupBy] || 'Inne';
          if (!groups[groupKey]) groups[groupKey] = [];
          groups[groupKey].push(item);
        });
        
        Object.keys(groups).sort().forEach(groupName => {
          if (groupName) {
            const groupHeader = document.createElement('div');
            groupHeader.className = 'menu-sec-title';
            groupHeader.textContent = groupName;
            groupHeader.style.padding = '12px 0 4px';
            groupHeader.style.fontWeight = '600';
            container.appendChild(groupHeader);
          }
          
          groups[groupName].forEach(it => {
            container.appendChild(createItemElement(it, lref));
          });
        });
        
        return;
      }
      
      items = extendedState.settings.hideCompleted ? 
        filteredItems.filter(i => !i.done) : 
        [...filteredItems.filter(i => !i.done), ...filteredItems.filter(i => i.done)];
    }
    
    if (items.length === 0) {
      el('emptyState').hidden = false;
      el('emptyState').textContent = isCompletedView ? 
        'Brak pozycji.' : 
        'Brak pozycji. Dodaj co≈õ przyciskiem +';
      return;
    } else {
      el('emptyState').hidden = true;
    }
    
    const frag = document.createDocumentFragment();
    items.forEach(it => frag.appendChild(createItemElement(it, lref)));
    container.appendChild(frag);
  }

  // Pozosta≈Çe funkcje pozostajƒÖ bez zmian, ale u≈ºywajƒÖ extendedState zamiast state
  // ... (reszta kodu)

})();
</script>
</body>
</html>