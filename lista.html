<!doctype html>
<html lang="pl" data-theme="light" data-density="normal" data-size="normal">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lista</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#ffffff; --card:#ffffff; --text:#0f172a; --muted:#64748b;
      --accent:#10b981; --danger:#ef4444; --border:#e5e7eb;
    }
    [data-theme="dark"]{
      --bg:#0b1220; --card:#0f172a; --text:#e5e7eb; --muted:#94a3b8;
      --accent:#34d399; --danger:#f87171; --border:#1f2937;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif; background:var(--bg); color:var(--text)}
    .wrap{max-width:680px; margin:40px auto; padding:16px}
    header{display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:20px}
    h1{margin:0; font-size:24px; font-weight:700; display:flex; align-items:center; gap:12px; cursor:pointer; padding:8px 12px; border-radius:12px; transition:background-color 0.2s}
    h1:hover{background:var(--border)}
    .dot{width:14px; height:14px; border-radius:50%}
    .chip{display:none} /* Ukrywamy chip caÅ‚kowicie */
    .icon-btn{height:36px; min-width:36px; padding:0 10px; display:inline-flex; align-items:center; justify-content:center; gap:8px; border:1px solid var(--border); background:transparent; color:var(--text); border-radius:10px; cursor:pointer}
    .icon-btn:active{transform:translateY(1px)}
    .row{display:flex; gap:8px}
    .input{height:44px; padding:0 12px; flex:1; border:1px solid var(--border); border-radius:10px; background:var(--card); color:var(--text); font-size:15px}
    .add-btn{height:44px; padding:0 14px; border:1px solid var(--border); background:var(--card); border-radius:10px; cursor:pointer}
    .list{list-style:none; padding:0; margin:12px 0 0}
    .item{display:grid; grid-template-columns: 24px 1fr 28px; align-items:center; gap:8px; border:1px solid var(--border); background:var(--card); border-radius:12px; padding:10px; margin:10px 0}
    .check{width:18px; height:18px; accent-color:var(--accent); cursor:pointer}
    .txt{min-height:22px; word-break:break-word}
    .txt[contenteditable="true"]{outline:2px solid var(--accent); border-radius:6px; padding:2px 4px; background:var(--bg)}
    .del{width:28px; height:28px; border:none; background:transparent; color:var(--muted); cursor:pointer}
    .item.done .txt{text-decoration:line-through; color:var(--muted)}
    .empty{margin-top:12px; color:var(--muted); font-size:14px}
    /* GÄ™stoÅ›Ä‡ i rozmiar */
    [data-density="compact"] .item{padding:8px; margin:6px 0}
    [data-size="big"] body{font-size:17px}
    [data-size="big"] .input{font-size:16px}
    /* Arkusze (sheet) */
    .sheet{position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:flex-end; z-index:50}
    .sheet[aria-hidden="false"]{display:flex}
    .card{width:100%; max-width:680px; margin:0 auto; background:var(--card); color:var(--text); border-top-left-radius:16px; border-top-right-radius:16px; padding:14px; border:1px solid var(--border)}
    .card h3{margin:0 0 8px; font-size:16px}
    .sec{margin:10px 0}
    .opt-row{display:flex; align-items:center; justify-content:space-between; gap:8px; padding:8px 0; border-bottom:1px solid var(--border)}
    .small{font-size:12px; color:var(--muted)}
    .btn{height:36px; padding:0 12px; border:1px solid var(--border); background:transparent; color:var(--text); border-radius:8px; cursor:pointer}
    .btn.primary{background:var(--accent); color:#fff; border-color:var(--accent)}
    .btn.danger{border-color:var(--danger); color:var(--danger)}
    .list-rows{display:flex; flex-direction:column; gap:6px; max-height:40vh; overflow:auto; border:1px solid var(--border); border-radius:10px; padding:8px}
    .row-item{display:flex; align-items:center; justify-content:space-between; gap:10px; padding:6px 4px; border-radius:8px}
    .row-item:hover{background:rgba(0,0,0,.04)}
    .name{display:flex; align-items:center; gap:8px}
    .dot-s{width:10px; height:10px; border-radius:50%}
    .sub{font-size:12px; color:var(--muted)}
    /* Toast notifications */
    .toast{position:fixed; top:20px; right:20px; padding:12px 16px; background:var(--card); border:1px solid var(--border); border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.1); z-index:1000; transform:translateX(120%); transition:transform 0.3s ease}
    .toast.show{transform:translateX(0)}
    .toast.success{border-left:4px solid var(--accent)}
    .toast.error{border-left:4px solid var(--danger)}
    .toast.info{border-left:4px solid var(--muted)}
    /* Zapisane / Historia */
    .rows{display:flex; flex-direction:column; gap:8px; max-height:50vh; overflow:auto}
    .card-row{border:1px solid var(--border); border-radius:12px; padding:10px}
    .actions{display:flex; gap:8px; flex-wrap:wrap}
    .preview{margin-top:6px; font-size:13px; color:var(--muted)}
    /* Druk â€“ kompaktowy, czarny */
    #printContainer{ display:none }
    @media print{
      @page{ margin:12mm }
      html, body{ background:#fff !important; color:#000 !important; font-size:11pt }
      *{ color:#000 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
      .wrap, .sheet{ display:none !important }
      #printContainer{ display:block !important }
      .prn-list{ margin:0 0 8mm }
      .prn-head{
        display:flex; align-items:center; justify-content:space-between;
        padding:0 0 2mm; margin:0 0 3mm; border-bottom:1px solid #000;
      }
      .prn-title{ font-weight:700 }
      .prn-meta{ font-size:10pt }
      .prn-ul{ list-style:none; margin:0; padding:0 }
      .prn-li{ margin:2.5mm 0; line-height:1.2; page-break-inside:avoid }
      .prn-li::before{ content:'[ ] ' }
      .prn-li.done::before{ content:'[x] ' }
      .prn-head.hidden{ display:none !important }
    }
  </style>
</head>
<body>
  <main class="wrap">
    <header>
      <h1><span id="hdr-dot" class="dot" style="background:#10b981"></span><span id="title" class="title">Lista</span></h1>
      <button id="menuBtn" class="icon-btn" aria-haspopup="dialog" aria-expanded="false">â‹¯</button>
    </header>

    <!-- USUNIÄ˜TY CHIP - juÅ¼ nie pokazujemy podwÃ³jnej nazwy -->

    <form id="addForm" class="row" autocomplete="off">
      <input id="addInput" class="input" placeholder="Dodaj..." />
      <button class="add-btn" aria-label="Dodaj">+</button>
    </form>

    <ul id="list" class="list"></ul>
    <div id="empty" class="empty" hidden>Brak elementÃ³w</div>
  </main>

  <!-- MENU -->
  <div id="menuSheet" class="sheet" aria-hidden="true">
    <div class="card">
      <div class="sec">
        <h3>Listy</h3>
        <div id="listsBox" class="list-rows"></div>
        <div class="row" style="margin-top:8px">
          <button id="newListBtn" class="btn">Nowa lista</button>
          <button id="deleteListBtn" class="btn danger">UsuÅ„ bieÅ¼Ä…cÄ…</button>
        </div>
      </div>
      <div class="sec">
        <h3>Akcje</h3>
        <div class="row" style="gap:8px; flex-wrap:wrap">
          <button id="savedBtn" class="btn">Zapisane</button>
          <button id="historyBtn" class="btn">Historia</button>
          <button id="copyBtn" class="btn">Kopiuj</button>
          <button id="printBtn" class="btn">Drukuj</button>
        </div>
      </div>
      <div class="sec">
        <h3>Ustawienia</h3>
        <div class="opt-row">
          <span>Motyw</span>
          <div class="row">
            <button data-theme="light" class="btn" id="themeLight">Jasny</button>
            <button data-theme="dark" class="btn" id="themeDark">Ciemny</button>
            <button data-theme="system" class="btn" id="themeSystem">System</button>
          </div>
        </div>
        <div class="opt-row">
          <label class="name"><input type="checkbox" id="toggleHide"> Ukryj zrobione</label>
          <span class="sub"></span>
        </div>
        <div class="row" style="margin-top:8px">
          <button id="styleBtn" class="btn">Styl strony</button>
          <button id="resetBtn" class="btn">Resetuj dane</button>
          <button id="hardResetBtn" class="btn danger">Twardy reset</button>
          <button id="closeMenu" class="btn" style="margin-left:auto">Zamknij</button>
        </div>
      </div>
    </div>
  </div>

  <!-- STYL STRONY -->
  <div id="styleSheet" class="sheet" aria-hidden="true">
    <div class="card">
      <h3>Styl strony</h3>
      <div class="opt-row">
        <span>GÄ™stoÅ›Ä‡</span>
        <div class="row">
          <button class="btn" id="densNormal">Normalna</button>
          <button class="btn" id="densCompact">Kompaktowa</button>
        </div>
      </div>
      <div class="opt-row">
        <span>Rozmiar tekstu</span>
        <div class="row">
          <button class="btn" id="sizeNormal">Normalny</button>
          <button class="btn" id="sizeBig">DuÅ¼y</button>
        </div>
      </div>
      <div class="opt-row">
        <span>Kolor listy</span>
        <input type="color" id="colorPick" />
      </div>
      <div class="row" style="margin-top:8px">
        <button id="closeStyle" class="btn" style="margin-left:auto">Zamknij</button>
      </div>
    </div>
  </div>

  <!-- ZAPISANE -->
  <div id="savedSheet" class="sheet" aria-hidden="true">
    <div class="card">
      <h3>Zapisane</h3>
      <div id="savedBox" class="rows"></div>
      <div class="row" style="margin-top:8px"><button class="btn" id="closeSaved">Zamknij</button></div>
    </div>
  </div>

  <!-- HISTORIA -->
  <div id="historySheet" class="sheet" aria-hidden="true">
    <div class="card">
      <h3>Historia</h3>
      <div id="historyBox" class="rows"></div>
      <div class="row" style="margin-top:8px"><button class="btn" id="closeHistory">Zamknij</button></div>
    </div>
  </div>

  <!-- DRUK/KOPIUJ -->
  <div id="actionSheet" class="sheet" aria-hidden="true">
    <div class="card">
      <h3 id="actionTitle">Wybierz listy</h3>
      <div class="opt-row">
        <label class="name"><input type="checkbox" id="includeDone" checked> UwzglÄ™dnij zrobione</label>
        <span class="sub"></span>
      </div>
      <div id="pickLists" class="list-rows" style="margin-top:8px"></div>
      <div id="printOpts" class="row" style="margin-top:8px">
        <label class="name"><input type="checkbox" id="showTitle" checked> PokaÅ¼ tytuÅ‚</label>
        <label class="name"><input type="checkbox" id="showDate" checked> PokaÅ¼ datÄ™</label>
      </div>
      <div class="row" style="margin-top:10px">
        <button id="doAction" class="btn primary">OK</button>
        <button id="closeAction" class="btn" style="margin-left:auto">Zamknij</button>
      </div>
    </div>
  </div>

  <script>
    // Storage keys
    const K_APP='list.app.v3'; // lists, items, history, saved, color
    const K_HIDE='list.hide'; const K_THEME='list.theme';
    const K_STYLE='list.style.v1'; // {density:'normal'|'compact', size:'normal'|'big'}

    // State
    let app = loadApp();
    let items = getList().items || [];
    let hideDone = loadJSON(K_HIDE, false);
    let style = loadJSON(K_STYLE, { density:'normal', size:'normal' });

    // Elements
    const listEl = document.getElementById('list');
    const emptyEl = document.getElementById('empty');
    const addForm = document.getElementById('addForm');
    const addInput = document.getElementById('addInput');
    const titleEl = document.getElementById('title');
    const hdrDot = document.getElementById('hdr-dot');

    const menuBtn = document.getElementById('menuBtn');
    const menuSheet = document.getElementById('menuSheet');
    const listsBox = document.getElementById('listsBox');
    const newListBtn = document.getElementById('newListBtn');
    const deleteListBtn = document.getElementById('deleteListBtn');
    const toggleHide = document.getElementById('toggleHide');
    const closeMenu = document.getElementById('closeMenu');

    const styleSheet = document.getElementById('styleSheet');
    const styleBtn = document.getElementById('styleBtn');
    const densNormal = document.getElementById('densNormal');
    const densCompact = document.getElementById('densCompact');
    const sizeNormal = document.getElementById('sizeNormal');
    const sizeBig = document.getElementById('sizeBig');
    const colorPick = document.getElementById('colorPick');
    const closeStyle = document.getElementById('closeStyle');

    const savedBtn = document.getElementById('savedBtn'); const savedSheet = document.getElementById('savedSheet'); const savedBox = document.getElementById('savedBox'); const closeSaved = document.getElementById('closeSaved');
    const historyBtn = document.getElementById('historyBtn'); const historySheet = document.getElementById('historySheet'); const historyBox = document.getElementById('historyBox'); const closeHistory = document.getElementById('closeHistory');

    const actionSheet = document.getElementById('actionSheet'); const actionTitle = document.getElementById('actionTitle'); const includeDone = document.getElementById('includeDone'); const pickLists = document.getElementById('pickLists'); const printOpts = document.getElementById('printOpts'); const showTitle = document.getElementById('showTitle'); const showDate = document.getElementById('showDate'); const doAction = document.getElementById('doAction'); const closeActionBtn = document.getElementById('closeAction');

    const copyBtn = document.getElementById('copyBtn'); const printBtn = document.getElementById('printBtn');
    const themeLight = document.getElementById('themeLight'); const themeDark = document.getElementById('themeDark'); const themeSystem = document.getElementById('themeSystem');
    const resetBtn = document.getElementById('resetBtn'); const hardResetBtn = document.getElementById('hardResetBtn');

    // Utils
    function uid(){ return (crypto && crypto.randomUUID) ? crypto.randomUUID() : 'id-'+Math.random().toString(36).slice(2)+Date.now().toString(36) }
    function loadJSON(k,f){ try{ const r=localStorage.getItem(k); return r? JSON.parse(r): f }catch(e){ console.error('BÅ‚Ä…d Å‚adowania',k,e); return f } }
    function saveJSON(k,v){ try{ localStorage.setItem(k, JSON.stringify(v)); return true }catch(e){ console.error('BÅ‚Ä…d zapisu',k,e); showToast('BÅ‚Ä…d zapisu danych','error'); return false } }
    function getList(){ return app.lists.find(l=>l.id===app.active) || app.lists[0] }
    function sync(){ items = getList().items || []; return items }
    function esc(s){ return String(s||'').replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])) }
    function fmt(ts){ try{ return new Intl.DateTimeFormat('pl-PL',{dateStyle:'medium', timeStyle:'short'}).format(new Date(ts)) }catch(e){ return new Date(ts).toLocaleString('pl-PL') } }
    function norm(s){ return String(s||'').trim().toLowerCase() }
    function systemTheme(){ return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark':'light' }

    // Toast notifications - 1.4 sekundy
    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      
      setTimeout(() => toast.classList.add('show'), 100);
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
      }, 1400); // Zmienione na 1.4 sekundy
    }

    // App load/repair
    function loadApp(){
      const raw = loadJSON(K_APP,null);
      if(raw){
        const a = repair(raw);
        if (!saveJSON(K_APP, a)) {
          showToast('BÅ‚Ä…d Å‚adowania danych', 'error');
        }
        return a;
      }
      const id = uid();
      const a = { active:id, lists:[{ id, name:'Lista', color:'#10b981', items:[], history:[] }], saved:[] };
      if (!saveJSON(K_APP,a)) {
        showToast('BÅ‚Ä…d inicjalizacji danych', 'error');
      }
      return a;
    }
    function repair(a){
      if(!a || typeof a!=='object') return { active: uid(), lists:[{id:uid(),name:'Lista',color:'#10b981',items:[],history:[]}], saved:[] };
      if(!Array.isArray(a.lists)||a.lists.length===0) a.lists=[{id:uid(),name:'Lista',color:'#10b981',items:[],history:[]}];
      a.lists=a.lists.map(l=>({ id:l.id||uid(), name:String(l.name||'Lista'), color: validColor(l.color)?l.color:'#10b981', items:Array.isArray(l.items)? l.items.map(it=>({ id:it?.id||uid(), text:String(it?.text||''), done:!!it?.done, createdAt: it?.createdAt||Date.now() })) : [], history:Array.isArray(l.history)? l.history.map(h=>({ id:h?.id||uid(), text:String(h?.text||''), lastAt:h?.lastAt||Date.now(), count:h?.count||1 })) : [] }));
      if(!Array.isArray(a.saved)) a.saved=[];
      a.saved=a.saved.map(s=>({ id:s?.id||uid(), name:String(s?.name||'Lista'), color: validColor(s?.color)?s.color:null, items:Array.isArray(s?.items)? s.items.map(it=>({ id:it?.id||uid(), text:String(it?.text||''), done:!!it?.done, createdAt: it?.createdAt||Date.now() })) : [], createdAt: s?.createdAt||Date.now() }));
      if(!a.active || !a.lists.find(x=>x.id===a.active)) a.active=a.lists[0].id;
      return a;
    }
    function validColor(c){ return typeof c==='string' && /^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(c) }
    function save(){ 
      if (!saveJSON(K_APP, app)) {
        showToast('BÅ‚Ä…d zapisu danych', 'error');
        return false;
      }
      return true;
    }

    // UI apply
    function applyTheme(mode){ const m= mode==='system'? systemTheme(): mode; document.documentElement.setAttribute('data-theme', m==='dark'?'dark':'light'); saveJSON(K_THEME, mode) }
    function applyHide(){ document.getElementById('toggleHide').checked = !!hideDone }
    function applyStyle(){
      document.documentElement.setAttribute('data-density', style.density==='compact'?'compact':'normal');
      document.documentElement.setAttribute('data-size', style.size==='big'?'big':'normal');
    }

    function refreshHeader(){
      const l=getList();
      titleEl.textContent=l.name||'Lista';
      hdrDot.style.background = l.color || '#10b981';
      // USUNIÄ˜TE: chipName.textContent - juÅ¼ nie uÅ¼ywamy chipa
    }

    // Render list - BEZPIECZNIE bez innerHTML
    function renderList(){
      const arr=sync();
      listEl.innerHTML='';
      arr.forEach(it=>{
        if(hideDone && it.done) return;
        
        const li=document.createElement('li');
        li.className='item'+(it.done?' done':'');
        li.dataset.id=it.id;

        // Checkbox
        const check=document.createElement('input');
        check.className='check';
        check.type='checkbox';
        check.checked=it.done;
        
        // Text element - BEZPIECZNIE
        const txt=document.createElement('div');
        txt.className='txt';
        txt.textContent=it.text; // Bez innerHTML!
        
        // Delete button
        const del=document.createElement('button');
        del.className='del';
        del.setAttribute('aria-label','UsuÅ„');
        del.textContent='âœ•'; // Bez innerHTML!

        li.appendChild(check);
        li.appendChild(txt);
        li.appendChild(del);
        listEl.appendChild(li);

        // Edycja zadania - podwÃ³jne klikniÄ™cie
        txt.addEventListener('dblclick', () => {
          if (txt.isContentEditable) return;
          txt.setAttribute('contenteditable', 'true');
          txt.focus();
          placeCaret(txt);
        });

        txt.addEventListener('keydown', (e) => {
          if (!txt.isContentEditable) return;
          if (e.key === 'Enter') {
            e.preventDefault();
            txt.blur();
          }
          if (e.key === 'Escape') {
            txt.textContent = it.text;
            txt.blur();
          }
        });

        txt.addEventListener('blur', () => {
          if (!txt.isContentEditable) return;
          const newText = (txt.textContent || '').trim();
          if (newText && newText !== it.text) {
            it.text = newText;
            if (save()) {
              showToast('Zadanie zaktualizowane', 'success');
            }
          } else if (!newText) {
            txt.textContent = it.text; // PrzywrÃ³Ä‡ poprzedni tekst jeÅ›li pusty
          }
          txt.removeAttribute('contenteditable');
        });
      });
      emptyEl.hidden = listEl.children.length>0;
    }

    // Lists in menu
    function renderListsBox(){
      listsBox.innerHTML='';
      app.lists.forEach(l=>{
        const row=document.createElement('div'); 
        row.className='row-item';
        
        const nameSpan = document.createElement('span');
        nameSpan.className = 'name';
        
        const dot = document.createElement('span');
        dot.className = 'dot-s';
        dot.style.background = l.color||'#10b981';
        
        nameSpan.appendChild(dot);
        nameSpan.appendChild(document.createTextNode(' ' + (l.name||'Lista')));
        
        row.appendChild(nameSpan);
        
        if(app.active===l.id){
          const sub = document.createElement('span');
          sub.className = 'sub';
          sub.textContent = 'bieÅ¼Ä…ca';
          row.appendChild(sub);
        }
        
        row.addEventListener('click',()=>{ 
          app.active=l.id; 
          if (save()) {
            refreshHeader(); 
            renderList(); 
            applyHide();
            showToast(`Aktywna lista: ${l.name}`, 'success');
          }
        });
        listsBox.appendChild(row);
      });
    }

    // Saved
    function renderSaved(){
      savedBox.innerHTML='';
      if(app.saved.length===0){
        const r=document.createElement('div'); 
        r.className='small'; 
        r.style.color='var(--muted)'; 
        r.textContent='Brak zapisanych'; 
        savedBox.appendChild(r); 
        return;
      }
      app.saved.slice().sort((a,b)=>b.createdAt-a.createdAt).forEach(s=>{
        const el=document.createElement('div'); 
        el.className='card-row'; 
        el.dataset.id=s.id;
        
        const count=s.items.length, pv=s.items.slice(0,8).map(x=> x.text).join(' â€¢ ');
        
        const rowDiv = document.createElement('div');
        rowDiv.className = 'row';
        rowDiv.style.justifyContent = 'space-between';
        
        const nameDiv = document.createElement('div');
        nameDiv.className = 'name';
        
        const dot = document.createElement('span');
        dot.className = 'dot-s';
        dot.style.background = s.color||'#10b981';
        
        const strong = document.createElement('strong');
        strong.textContent = s.name;
        
        nameDiv.appendChild(dot);
        nameDiv.appendChild(strong);
        
        const sub = document.createElement('span');
        sub.className = 'sub';
        sub.textContent = `${fmt(s.createdAt)} â€¢ ${count}`;
        
        rowDiv.appendChild(nameDiv);
        rowDiv.appendChild(sub);
        
        const actions = document.createElement('div');
        actions.className = 'actions';
        actions.style.marginTop = '8px';
        
        const addBtn = document.createElement('button');
        addBtn.className = 'btn';
        addBtn.dataset.act = 'add';
        addBtn.textContent = 'âž• Dodaj';
        
        const replaceBtn = document.createElement('button');
        replaceBtn.className = 'btn';
        replaceBtn.dataset.act = 'replace';
        replaceBtn.textContent = 'â™»ï¸ ZastÄ…p';
        
        const newBtn = document.createElement('button');
        newBtn.className = 'btn';
        newBtn.dataset.act = 'new';
        newBtn.textContent = 'ðŸ†• Nowa lista';
        
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'btn danger';
        deleteBtn.dataset.act = 'delete';
        deleteBtn.textContent = 'ðŸ—‘ï¸ UsuÅ„';
        
        actions.appendChild(addBtn);
        actions.appendChild(replaceBtn);
        actions.appendChild(newBtn);
        actions.appendChild(deleteBtn);
        
        const preview = document.createElement('div');
        preview.className = 'preview';
        preview.textContent = pv + (count>8? ' â€¦':'');
        
        el.appendChild(rowDiv);
        el.appendChild(actions);
        el.appendChild(preview);
        savedBox.appendChild(el);
      });
    }

    // History
    function renderHistory(){
      historyBox.innerHTML='';
      const all = [];
      app.lists.forEach(l=>{
        (l.history||[]).forEach(h=> all.push({ ...h, listName:l.name, color:l.color }));
      });
      if(all.length===0){ 
        const r=document.createElement('div'); 
        r.className='small'; 
        r.style.color='var(--muted)'; 
        r.textContent='Brak historii'; 
        historyBox.appendChild(r); 
        return; 
      }
      all.sort((a,b)=> (b.lastAt||0)-(a.lastAt||0)).forEach(h=>{
        const el=document.createElement('div'); 
        el.className='card-row';
        
        const rowDiv = document.createElement('div');
        rowDiv.className = 'row';
        rowDiv.style.justifyContent = 'space-between';
        
        const nameDiv = document.createElement('div');
        nameDiv.className = 'name';
        
        const dot = document.createElement('span');
        dot.className = 'dot-s';
        dot.style.background = h.color||'#10b981';
        
        nameDiv.appendChild(dot);
        nameDiv.appendChild(document.createTextNode(' ' + h.listName));
        
        const sub = document.createElement('span');
        sub.className = 'sub';
        sub.textContent = `${fmt(h.lastAt)} â€¢ Ã—${h.count||1}`;
        
        rowDiv.appendChild(nameDiv);
        rowDiv.appendChild(sub);
        
        const textRow = document.createElement('div');
        textRow.className = 'row';
        textRow.style.margin = '6px 0 8px 0';
        
        const textDiv = document.createElement('div');
        textDiv.textContent = h.text;
        
        textRow.appendChild(textDiv);
        
        const actions = document.createElement('div');
        actions.className = 'actions';
        
        const addBtn = document.createElement('button');
        addBtn.className = 'btn';
        addBtn.dataset.act = 'add';
        addBtn.textContent = 'âž• Dodaj do bieÅ¼Ä…cej';
        
        actions.appendChild(addBtn);
        
        el.appendChild(rowDiv);
        el.appendChild(textRow);
        el.appendChild(actions);
        
        // zapisz tekst w dataset do pÃ³Åºniejszego dodania
        el.dataset.text = h.text;
        historyBox.appendChild(el);
      });
    }

    // Actions
    addForm.addEventListener('submit', e=>{
      e.preventDefault();
      const t=(addInput.value||'').trim().replace(/\s+/g,' ');
      if(!t) return;
      const l=getList(); const act=(l.items||[]).filter(i=>!i.done), done=(l.items||[]).filter(i=>i.done);
      l.items=[{id:uid(), text:t, done:false, createdAt:Date.now()}, ...act, ...done];
      if (save()) {
        addInput.value=''; 
        renderList();
        showToast('Zadanie dodane', 'success');
      }
    });

    listEl.addEventListener('change', e=>{
      if(!e.target.classList.contains('check')) return;
      const id=e.target.closest('.item').dataset.id;
      const l=getList(); const idx=l.items.findIndex(i=>i.id===id);
      if(idx===-1) return;
      l.items[idx].done = e.target.checked;
      const it=l.items.splice(idx,1)[0];
      const act=l.items.filter(i=>!i.done), done=l.items.filter(i=>i.done);
      l.items = it.done ? [...act, ...done, it] : [it, ...act, ...done];
      if (save()) {
        renderList();
        showToast(it.done ? 'Zadanie ukoÅ„czone' : 'Zadanie przywrÃ³cone', 'success');
      }
    });

    listEl.addEventListener('click', e=>{
      if(!e.target.classList.contains('del')) return;
      const id=e.target.closest('.item').dataset.id;
      const l=getList(); const idx=l.items.findIndex(i=>i.id===id); if(idx===-1) return;
      const it=l.items[idx];
      l.items.splice(idx,1);
      // historia
      const n=norm(it.text); const hist=l.history||(l.history=[]);
      const ex=hist.find(h=> norm(h.text)===n);
      if(ex){ ex.lastAt=Date.now(); ex.count=(ex.count||1)+1 } else { hist.push({ id:uid(), text:it.text, lastAt:Date.now(), count:1 }) }
      if (save()) {
        renderList();
        showToast('Zadanie usuniÄ™te', 'success');
      }
    });

    // Title edit - teraz caÅ‚y nagÅ‚Ã³wek jest edytowalny
    titleEl.parentElement.addEventListener('dblclick', ()=>{
      titleEl.setAttribute('contenteditable','true'); 
      placeCaret(titleEl); 
      titleEl.focus();
    });
    titleEl.addEventListener('keydown', e=>{
      if(!titleEl.isContentEditable) return;
      if(e.key==='Enter'){ e.preventDefault(); titleEl.blur() }
      if(e.key==='Escape'){ titleEl.textContent=getList().name||'Lista'; titleEl.blur() }
    });
    titleEl.addEventListener('blur', ()=>{
      if(!titleEl.isContentEditable) return;
      const l=getList();
      let n = (titleEl.textContent||'').trim()||'Lista';
      l.name=n; 
      if (save()) {
        refreshHeader();
        showToast('Nazwa listy zaktualizowana', 'success');
      }
      titleEl.removeAttribute('contenteditable');
    });
    function placeCaret(el){ 
      const r=document.createRange(); 
      r.selectNodeContents(el); 
      r.collapse(false); 
      const s=getSelection(); 
      s.removeAllRanges(); 
      s.addRange(r); 
    }

    // Menu
    menuBtn.addEventListener('click', openMenu);
    function openMenu(){ renderListsBox(); applyHide(); menuSheet.setAttribute('aria-hidden','false'); }
    closeMenu.addEventListener('click', ()=> menuSheet.setAttribute('aria-hidden','true'));
    toggleHide.addEventListener('change', ()=>{ 
      hideDone = toggleHide.checked; 
      saveJSON(K_HIDE, hideDone); 
      renderList(); 
      showToast(hideDone ? 'Ukryto ukoÅ„czone' : 'Pokazano ukoÅ„czone', 'info');
    });

    // Styl strony
    styleBtn.addEventListener('click', ()=>{
      menuSheet.setAttribute('aria-hidden','true');
      colorPick.value = getList().color || '#10b981';
      styleSheet.setAttribute('aria-hidden','false');
    });
    densNormal.addEventListener('click', ()=>{ style.density='normal'; applyStyle(); saveJSON(K_STYLE, style); showToast('GÄ™stoÅ›Ä‡: normalna', 'info') });
    densCompact.addEventListener('click', ()=>{ style.density='compact'; applyStyle(); saveJSON(K_STYLE, style); showToast('GÄ™stoÅ›Ä‡: kompaktowa', 'info') });
    sizeNormal.addEventListener('click', ()=>{ style.size='normal'; applyStyle(); saveJSON(K_STYLE, style); showToast('Rozmiar: normalny', 'info') });
    sizeBig.addEventListener('click', ()=>{ style.size='big'; applyStyle(); saveJSON(K_STYLE, style); showToast('Rozmiar: duÅ¼y', 'info') });
    colorPick.addEventListener('input', ()=>{
      const l=getList(); l.color = colorPick.value; 
      if (save()) {
        refreshHeader();
        showToast('Kolor listy zaktualizowany', 'success');
      }
    });
    closeStyle.addEventListener('click', ()=> styleSheet.setAttribute('aria-hidden','true'));

    // Saved sheet
    savedBtn.addEventListener('click', ()=>{ renderSaved(); savedSheet.setAttribute('aria-hidden','false') });
    closeSaved.addEventListener('click', ()=> savedSheet.setAttribute('aria-hidden','true'));
    savedBox.addEventListener('click', e=>{
      const row=e.target.closest('.card-row'); if(!row) return; const id=row.dataset.id;
      const s=app.saved.find(x=>x.id===id); if(!s) return;
      if(e.target.dataset.act==='delete'){
        app.saved=app.saved.filter(x=>x.id!==id); 
        if (save()) {
          renderSaved(); 
          showToast('Zapis usuniÄ™ty', 'success');
        }
        return;
      }
      if(e.target.dataset.act==='add'){
        const cur=getList(); const arr=cur.items||[]; const exist=new Set(arr.map(i=>norm(i.text)));
        const toAdd=(s.items||[]).reduce((acc,it)=>{ const t=norm(it.text); if(!t||exist.has(t)) return acc; exist.add(t); acc.push({id:uid(),text:it.text,done:false,createdAt:Date.now()}); return acc },[]);
        const act=arr.filter(i=>!i.done), done=arr.filter(i=>i.done);
        cur.items=[...toAdd, ...act, ...done]; 
        if (save()) {
          savedSheet.setAttribute('aria-hidden','true'); 
          renderList();
          showToast(`Dodano ${toAdd.length} zadaÅ„`, 'success');
        }
        return;
      }
      if(e.target.dataset.act==='replace'){
        if(!confirm('ZastÄ…piÄ‡ bieÅ¼Ä…cÄ… listÄ™ tym zapisem?')) return;
        const cur=getList(); cur.items=(s.items||[]).map(it=>({id:uid(),text:it.text,done:!!it.done,createdAt:Date.now()})); 
        if (save()) {
          savedSheet.setAttribute('aria-hidden','true'); 
          renderList();
          showToast('Lista zastÄ…piona', 'success');
        }
        return;
      }
      if(e.target.dataset.act==='new'){
        const name=uniqueName(s.name||'Lista'); const idNew=uid();
        app.lists.push({ id:idNew, name, color: s.color || '#10b981', items: (s.items||[]).map(it=>({id:uid(),text:it.text,done:!!it.done,createdAt:Date.now()})), history:[] });
        app.active=idNew; 
        if (save()) {
          savedSheet.setAttribute('aria-hidden','true'); 
          refreshHeader(); 
          renderList();
          showToast(`Utworzono nowÄ… listÄ™: ${name}`, 'success');
        }
      }
    });
    function uniqueName(base){
      const names=new Set(app.lists.map(l=>l.name.trim().toLowerCase()));
      if(!names.has(base.trim().toLowerCase())) return base;
      let i=1; while(names.has((base+' ('+i+')').toLowerCase())) i++; return base+' ('+i+')';
    }

    // Historia sheet (dodawanie do listy)
    historyBtn.addEventListener('click', ()=>{ renderHistory(); historySheet.setAttribute('aria-hidden','false') });
    closeHistory.addEventListener('click', ()=> historySheet.setAttribute('aria-hidden','true'));
    historyBox.addEventListener('click', e=>{
      const row=e.target.closest('.card-row'); if(!row) return;
      if(e.target.dataset.act!=='add') return;
      const text = row.querySelector('.row div')?.textContent || row.dataset.text;
      if(!text) return;
      const cur=getList(); const arr=cur.items||[]; const exists=arr.find(i=> norm(i.text)===norm(text));
      if(!exists){
        const act=arr.filter(i=>!i.done), done=arr.filter(i=>i.done);
        cur.items=[{id:uid(), text, done:false, createdAt:Date.now()}, ...act, ...done];
        if (save()) {
          renderList();
          showToast('Zadanie dodane z historii', 'success');
        }
      } else {
        showToast('Zadanie juÅ¼ istnieje na liÅ›cie', 'info');
      }
    });

    // Copy / Print
    copyBtn.addEventListener('click', ()=> openAction('copy'));
    printBtn.addEventListener('click', ()=> openAction('print'));
    closeActionBtn.addEventListener('click', ()=> actionSheet.setAttribute('aria-hidden','true'));
    function openAction(kind){
      pickLists.innerHTML='';
      app.lists.forEach(l=>{
        const row=document.createElement('div'); row.className='row-item';
        
        const label = document.createElement('label');
        label.className = 'name';
        
        const input = document.createElement('input');
        input.type = 'checkbox';
        input.dataset.id = l.id;
        input.checked = l.id===app.active;
        
        const dot = document.createElement('span');
        dot.className = 'dot-s';
        dot.style.background = l.color||'#10b981';
        
        label.appendChild(input);
        label.appendChild(dot);
        label.appendChild(document.createTextNode(' ' + l.name));
        
        row.appendChild(label);
        pickLists.appendChild(row);
      });
      includeDone.checked=true;
      if(kind==='copy'){ actionTitle.textContent='Kopiuj listy'; printOpts.style.display='none' }
      else{ actionTitle.textContent='Drukuj listy'; printOpts.style.display='flex' }
      doAction.onclick = ()=> kind==='copy' ? doCopy() : doPrint();
      actionSheet.setAttribute('aria-hidden','false');
    }
    function selectedIds(){ return Array.from(pickLists.querySelectorAll('input[type=checkbox]:checked')).map(i=> i.dataset.id) }
    function doCopy(){
      const ids=selectedIds(); if(ids.length===0){ showToast('Wybierz listy', 'error'); return }
      const include=includeDone.checked;
      const now=fmt(Date.now());
      const parts=[`Zestawienie list â€¢ ${now}`, ''];
      ids.forEach(id=>{
        const l=app.lists.find(x=>x.id===id); if(!l) return;
        parts.push(l.name||'Lista');
        (l.items||[]).forEach(it=>{ if(!include && it.done) return; parts.push(`- [${it.done?'x':' '}] ${it.text}`) });
        parts.push('');
      });
      const text=parts.join('\n').replace(/\n{3,}/g,'\n\n');
      try{
        if(navigator.clipboard && window.isSecureContext){ 
          navigator.clipboard.writeText(text).then(() => {
            showToast('Skopiowano do schowka', 'success');
          }).catch(() => {
            fallbackCopy(text);
          });
        } else { 
          fallbackCopy(text);
        }
      }catch(e){ 
        showToast('Nie udaÅ‚o siÄ™ skopiowaÄ‡', 'error');
      }
      actionSheet.setAttribute('aria-hidden','true');
    }
    function fallbackCopy(text) {
      const ta=document.createElement('textarea'); 
      ta.value=text; 
      document.body.appendChild(ta); 
      ta.select(); 
      document.execCommand('copy'); 
      document.body.removeChild(ta);
      showToast('Skopiowano do schowka', 'success');
    }
    function doPrint(){
      const ids=selectedIds(); if(ids.length===0){ showToast('Wybierz listy', 'error'); return }
      const include=includeDone.checked;
      const st=showTitle.checked, sd=showDate.checked;
      const now=fmt(Date.now());
      const cont=document.getElementById('printContainer');
      cont.innerHTML='';
      ids.forEach(id=>{
        const l=app.lists.find(x=>x.id===id); if(!l) return;
        const sec=document.createElement('section'); sec.className='prn-list prn-wrap';
        const head=document.createElement('div'); head.className='prn-head'+(!st&&!sd?' hidden':'');
        head.innerHTML=`<div class="prn-title">${st? esc(l.name||'Lista'): ''}</div><div class="prn-meta">${sd? 'Data: '+esc(now): ''}</div>`;
        const ul=document.createElement('ul'); ul.className='prn-ul';
        (l.items||[]).forEach(it=>{ if(!include&&it.done) return; const li=document.createElement('li'); li.className='prn-li'+(it.done?' done':''); li.textContent=it.text||''; ul.appendChild(li) });
        sec.appendChild(head); sec.appendChild(ul); cont.appendChild(sec);
      });
      actionSheet.setAttribute('aria-hidden','true');
      requestAnimationFrame(()=> setTimeout(()=> window.print?.(), 0));
    }

    // Theme
    document.getElementById('themeLight').addEventListener('click', ()=> { applyTheme('light'); showToast('Motyw: jasny', 'info') });
    document.getElementById('themeDark').addEventListener('click', ()=> { applyTheme('dark'); showToast('Motyw: ciemny', 'info') });
    document.getElementById('themeSystem').addEventListener('click', ()=> { applyTheme('system'); showToast('Motyw: systemowy', 'info') });
    applyTheme(loadJSON(K_THEME,'system'));

    // Reset
    resetBtn.addEventListener('click', ()=>{
      if(!confirm('ZresetowaÄ‡ dane tej aplikacji?')) return;
      [K_APP, K_HIDE, K_THEME, K_STYLE].forEach(k=> localStorage.removeItem(k));
      showToast('Dane zresetowane', 'success');
      setTimeout(() => location.reload(), 1000);
    });
    hardResetBtn.addEventListener('click', ()=>{
      if(!confirm('Twardy reset: usunie caÅ‚y localStorage tej strony. KontynuowaÄ‡?')) return;
      localStorage.clear(); 
      showToast('Wszystkie dane usuniÄ™te', 'success');
      setTimeout(() => location.reload(), 1000);
    });

    // Nowa lista
    newListBtn.addEventListener('click', () => {
      const name = uniqueName('Nowa lista');
      const idNew = uid();
      app.lists.push({ id: idNew, name, color: '#10b981', items: [], history: [] });
      app.active = idNew;
      if (save()) {
        refreshHeader();
        renderList();
        renderListsBox();
        showToast(`Utworzono listÄ™: ${name}`, 'success');
      }
    });

    // UsuÅ„ listÄ™
    deleteListBtn.addEventListener('click', () => {
      if (app.lists.length <= 1) {
        showToast('Nie moÅ¼na usunÄ…Ä‡ jedynej listy', 'error');
        return;
      }
      const currentList = getList();
      if (!confirm(`Czy na pewno chcesz usunÄ…Ä‡ listÄ™ "${currentList.name}"?`)) return;
      
      app.lists = app.lists.filter(l => l.id !== currentList.id);
      app.active = app.lists[0].id;
      if (save()) {
        refreshHeader();
        renderList();
        renderListsBox();
        showToast('Lista usuniÄ™ta', 'success');
      }
    });

    // Init
    function init(){
      applyHide();
      applyStyle();
      refreshHeader();
      renderList();
    }
    init();

    // ESC zamyka arkusze
    document.addEventListener('keydown', e=>{
      if(e.key==='Escape'){
        [menuSheet, savedSheet, historySheet, actionSheet, styleSheet].forEach(s=> s.setAttribute('aria-hidden','true'));
      }
    });
  </script>

  <!-- Kontener druku -->
  <div id="printContainer" style="display:none"></div>
</body>
</html>