<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Lista • Zadania i Zakupy</title>
<meta name="color-scheme" content="light dark" />
<style>
  :root{
    --bg: #f6f7fb;
    --text: #111318;
    --muted: #566074;
    --card: #ffffff;
    --border: #e6e8f0;
    --accent: #4a90e2;
    --accent-soft: rgba(74,144,226,0.12);
    --shadow: 0 8px 24px rgba(17,19,24,0.08);
    --shadow-soft: 0 4px 12px rgba(17,19,24,0.06);
    --radius: 16px;
    --header-h: 64px;
    --nav-h: 72px;
    --safe-bottom: env(safe-area-inset-bottom);
    --safe-top: env(safe-area-inset-top);
    --focus: 0 0 0 3px rgba(74,144,226,0.3);
    --danger: #d53b3b;
  }
  [data-theme="dark"]{
    --bg: #0c0f14;
    --text: #e6e8ef;
    --muted: #9aa3b2;
    --card: #161a22;
    --border: #232938;
    --shadow: 0 8px 24px rgba(0,0,0,0.45);
    --shadow-soft: 0 4px 12px rgba(0,0,0,0.35);
    --accent-soft: color-mix(in oklab, var(--accent) 15%, transparent);
  }
  *{box-sizing: border-box}
  html,body{height:100%}
  body{
    margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;
    background: var(--bg); color: var(--text); -webkit-tap-highlight-color: transparent;
  }
  button,input,select{font-family:inherit; color:inherit}

  .app{ min-height:100dvh; display:flex; flex-direction:column; padding-top:var(--safe-top); }

  /* Header */
  .app-header{
    position:sticky; top:0; z-index:20; height:var(--header-h);
    backdrop-filter: blur(8px);
    background: linear-gradient(180deg, color-mix(in oklab, var(--accent) 12%, var(--bg)) 0%, var(--bg) 70%);
    border-bottom: 1px solid var(--border);
    display:flex; align-items:center; padding:0 16px;
  }
  .title-button{
    display:flex; align-items:center; gap:10px; padding:10px 12px; border-radius:12px;
    background: var(--card); box-shadow: var(--shadow-soft); border:1px solid var(--border);
    cursor:pointer; user-select:none;
  }
  .title-button:active{transform:scale(0.98)}
  .dot{ width:10px; height:10px; border-radius:50%; background:var(--accent); box-shadow:0 0 0 3px var(--accent-soft) }
  .title-text{font-weight:600}
  .caret{width:16px; height:16px; opacity:0.7}

  /* Dropdown */
  .dropdown{
    position:absolute; top: calc(var(--header-h) - 6px); left:12px; right:12px;
    background: var(--card); border:1px solid var(--border); border-radius:18px;
    box-shadow: var(--shadow); padding:8px; display:none; max-height:60dvh; overflow:auto;
  }
  .dropdown.open{display:block; animation: pop 160ms ease-out}
  @keyframes pop{from{transform:translateY(-8px); opacity:0} to{transform:translateY(0); opacity:1}}

  .menu-sec-title{font-size:12px; color:var(--muted); padding:6px 10px}
  .menu-item{
    display:flex; align-items:center; gap:10px; width:100%; border:0; background:transparent;
    padding:10px; border-radius:12px; cursor:pointer; user-select:none;
  }
  .menu-item:hover{background: color-mix(in oklab, var(--card) 92%, var(--accent) 8%)}
  .menu-item .name{flex:1; text-align:left}
  .pill{background: var(--accent-soft); color: var(--accent); border-radius:999px; font-size:12px; padding:2px 8px}
  .color-dot{width:10px; height:10px; border-radius:50%}
  .grip{opacity:.5; display:grid; place-items:center; cursor:grab}
  .menu-item.drag-over{outline:2px dashed var(--accent); outline-offset:2px}

  /* Main content */
  main{flex:1; padding:12px 12px calc(var(--nav-h) + var(--safe-bottom) + 12px); max-width:900px; width:100%; margin:0 auto}
  .print-header{display:none; font-size:18px; font-weight:700; margin:6px 0 12px}
  .list{ display:grid; gap:8px; }
  .empty{ color:var(--muted); text-align:center; margin-top:18vh; font-size:15px; }

  /* Item */
  .item{
    display:flex; align-items:center; gap:12px; background: var(--card); border:1px solid var(--border);
    padding:12px; border-radius:14px; box-shadow: var(--shadow-soft);
    transition: transform .15s ease, background .2s ease, opacity .2s ease;
  }
  .item.new{animation: slideIn .18s ease-out}
  @keyframes slideIn{from{transform:translateY(8px); opacity:.0} to{transform:translateY(0); opacity:1}}
  .item:active{transform:scale(0.995)}

  /* Jasne checkboxy (custom) w pozycjach listy */
  .item input[type="checkbox"]{
    -webkit-appearance:none; appearance:none;
    width:22px; height:22px; border-radius:6px; flex-shrink:0;
    border:2px solid var(--border); background: var(--card);
    display:grid; place-items:center; transition: background .15s, border-color .15s, transform .1s;
  }
  .item input[type="checkbox"]:active{ transform: scale(0.96) }
  .item input[type="checkbox"]:checked{
    background: var(--accent); border-color: var(--accent);
  }
  .item input[type="checkbox"]:checked::after{
    content:''; width:10px; height:6px; border-left:2px solid #fff; border-bottom:2px solid #fff; transform: rotate(-45deg); margin-top:-1px;
  }

  .item .texts{display:flex; flex-direction:column; gap:4px; flex:1; min-width:0}
  .item .text{ font-size:16px; line-height:1.35; word-break:break-word; transition: color .2s ease; }
  .item.done .text{color: var(--muted); text-decoration: line-through; text-decoration-thickness: 1.5px}
  .sub{color: var(--muted); font-size:12px}

  /* Edit mode */
  .edit-on .item input[type="checkbox"]{display:none}
  .edit-on .item .text{border:1px dashed transparent; border-radius:8px; padding:4px 6px}
  .edit-on .item .text[contenteditable="true"]:focus{border-color: var(--accent); outline:none; box-shadow: var(--focus)}
  .item .handle{
    display:none; width:24px; height:24px; opacity:.55; flex-shrink:0; cursor:grab;
  }
  .edit-on .item .handle{display:block}
  .item .actions{display:none; gap:6px; align-items:center}
  .edit-on .item .actions{display:flex}
  .i-btn{
    width:34px; height:34px; display:grid; place-items:center; border-radius:10px; border:1px solid var(--border); background: var(--card);
  }
  .i-btn:active{transform:scale(0.96)}
  .i-btn.danger{color: var(--danger); border-color: color-mix(in oklab, var(--danger) 30%, var(--border)); background: color-mix(in oklab, var(--danger) 10%, var(--card))}
  .item.drag-over{ outline:2px dashed var(--accent); outline-offset:2px; }
  .item.dragging{ opacity:.98; box-shadow: 0 12px 28px rgba(0,0,0,.18); transform: scale(1.01); }
  .placeholder{ border:2px dashed var(--border) !important; background: color-mix(in oklab, var(--card) 80%, var(--accent) 20%) !important; }

  /* Bottom nav */
  .bottom-nav{
    position:fixed; left:0; right:0; bottom:0; height: calc(var(--nav-h) + var(--safe-bottom));
    padding-bottom: var(--safe-bottom);
    background: var(--card); border-top:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; padding:0 16px; z-index:25;
    gap:12px;
  }
  .nav-left, .nav-right{display:flex; gap:10px; align-items:center}
  .icon-btn{
    width:44px; height:44px; border-radius:12px; border:1px solid var(--border); background:var(--card); display:grid; place-items:center;
    box-shadow: var(--shadow-soft);
  }
  .icon-btn:active{transform:scale(0.96)}
  .icon-btn.active{outline:2px solid var(--accent); outline-offset:2px}
  .fab{
    position:absolute; left:50%; transform: translateX(-50%) translateY(-16%);
    width:56px; height:56px; border-radius:50%;
    border:0; background: linear-gradient(135deg, var(--accent), color-mix(in oklab, var(--accent) 60%, #fff));
    color:#fff; display:grid; place-items:center; box-shadow: 0 10px 24px color-mix(in oklab, var(--accent) 30%, transparent);
  }
  .fab:active{transform: translateX(-50%) translateY(-16%) scale(0.97)}
  .disabled, .icon-btn[disabled], .btn[disabled]{opacity:.45; pointer-events:none; filter: grayscale(.1);}

  /* Quick add */
  .quick-add{
    position: fixed; left:12px; right:12px; bottom: calc(var(--nav-h) + var(--safe-bottom) + 10px);
    background: var(--card); border:1px solid var(--border); border-radius:14px; box-shadow: var(--shadow);
    display:none; padding:8px; gap:8px; align-items:center;
  }
  .quick-add.open{display:flex; animation: pop .12s ease-out}
  .quick-add input{ flex:1; border:0; background:transparent; outline:none; padding:10px; border-radius:10px; }

  /* Dialogs */
  dialog{
    border:0; border-radius:18px; padding:0; background: var(--card); color: var(--text); width:min(520px, 92vw);
    box-shadow: var(--shadow);
  }
  dialog::backdrop{background: rgba(10,12,16,0.45); backdrop-filter: blur(3px)}
  .dlg-head{padding:16px 18px; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between}
  .dlg-title{font-weight:700}
  .dlg-body{padding:14px 18px; display:grid; gap:12px}
  .field{display:grid; gap:6px}
  .label{font-size:13px; color:var(--muted)}
  input[type="text"], select{
    width:100%; border:1px solid var(--border); background: var(--card); color: var(--text);
    border-radius:12px; padding:12px; outline:none;
  }
  .row{display:flex; gap:10px; align-items:center}
  .row.wrap{flex-wrap:wrap}
  .grow{flex:1}
  .switch{
    position:relative; width:48px; height:28px; background: var(--border); border-radius:999px; cursor:pointer; border:1px solid var(--border);
  }
  .switch input{display:none}
  .switch .knob{
    position:absolute; top:50%; left:4px; transform:translateY(-50%); width:20px; height:20px; border-radius:50%;
    background:#fff; box-shadow: var(--shadow-soft); transition: left .18s ease, background .18s ease;
  }
  .switch input:checked + .knob{ left:24px; background: var(--accent)}
  .dlg-foot{display:flex; gap:10px; justify-content:flex-end; padding:14px 18px; border-top:1px solid var(--border)}
  .btn{ padding:10px 14px; border-radius:12px; border:1px solid var(--border); background:var(--card); cursor:pointer; }
  .btn.primary{ background: var(--accent); border-color: transparent; color:#fff; }
  .btn.danger{color: var(--danger); border-color: color-mix(in oklab, var(--danger) 30%, var(--border)); background: color-mix(in oklab, var(--danger) 10%, var(--card))}
  .hint{font-size:12px; color:var(--muted)}

  /* Lekkie checkboxy w dialogach (druk/udostępnij) */
  dialog input[type="checkbox"]{
    -webkit-appearance:none; appearance:none;
    width:18px; height:18px; border-radius:4px; border:2px solid var(--border); background: var(--card);
    display:inline-grid; place-items:center; vertical-align:middle;
    margin:0;
  }
  dialog input[type="checkbox"]:checked{
    background: var(--accent); border-color: var(--accent);
  }
  dialog input[type="checkbox"]:checked::after{
    content:''; width:8px; height:5px; border-left:2px solid #fff; border-bottom:2px solid #fff; transform: rotate(-45deg);
  }

  /* Color palette (10 kolorów) */
  .swatch-grid{display:grid; grid-template-columns: repeat(10, 1fr); gap:8px}
  .swatch{
    width:28px; height:28px; border-radius:999px; border:2px solid #fff; box-shadow: 0 0 0 2px var(--border); cursor:pointer;
  }
  .swatch.selected{box-shadow: 0 0 0 2px var(--accent)}
</style>
</head>
<body>
<div class="app" id="app">
  <header class="app-header">
    <button class="title-button" id="openMenuBtn" aria-haspopup="true" aria-expanded="false">
      <span class="dot" id="listDot"></span>
      <span class="title-text" id="currentListName">Moja lista</span>
      <svg class="caret" viewBox="0 0 24 24" fill="none" aria-hidden="true">
        <path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>

    <div class="dropdown" id="listMenu" role="menu" aria-label="Wybierz listę">
      <div class="menu-sec">
        <div class="menu-sec-title">Moje listy <span class="hint">• przeciągaj aby zmienić kolejność</span></div>
        <div id="listMenuItems"></div>
      </div>
      <div class="menu-sec">
        <div class="menu-sec-title">Inne</div>
        <button class="menu-item" id="completedViewBtn">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
            <path d="M20 12a8 8 0 11-16 0 8 8 0 0116 0z" stroke="currentColor" stroke-width="2"/>
            <path d="M9 12l2 2 4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <span class="name">Zakończone</span>
        </button>
      </div>
      <div class="menu-sec">
        <button class="menu-item" id="manageListBtn">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
            <path d="M12 15a3 3 0 100-6 3 3 0 000 6z" stroke="currentColor" stroke-width="2"/>
            <path d="M19.5 12a7.5 7.5 0 10-15 0 7.5 7.5 0 0015 0z" stroke="currentColor" stroke-width="1.4" opacity=".4"/>
          </svg>
          <span class="name">Zarządzaj listą</span>
        </button>
        <button class="menu-item" id="addListBtn">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
            <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
          <span class="name">Nowa lista</span>
        </button>
      </div>
    </div>
  </header>

  <main>
    <div id="printHeader" class="print-header"></div>
    <div id="listContainer" class="list"></div>
    <div id="emptyState" class="empty" hidden>Brak pozycji.</div>
  </main>

  <nav class="bottom-nav">
    <div class="nav-left">
      <button class="icon-btn" id="quickAddBtn" aria-label="Szybkie dodanie">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
          <path d="M5 12h14M12 5v14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>
    </div>

    <button class="fab" id="addBtn" aria-label="Dodaj">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
        <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      </svg>
    </button>

    <div class="nav-right">
      <button class="icon-btn" id="editModeBtn" aria-label="Tryb edycji">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
          <path d="M15.2 5.2l3.6 3.6M7 17l-1 4 4-1 9.6-9.6a2.5 2.5 0 00-3.6-3.6L7 17z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
      <button class="icon-btn" id="undoBtn" aria-label="Cofnij" hidden disabled>
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
          <path d="M8 7l-5 5 5 5M3 12h11a6 6 0 010 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" opacity=".9"/>
        </svg>
      </button>
      <button class="icon-btn" id="redoBtn" aria-label="Ponów" hidden disabled>
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
          <path d="M16 7l5 5-5 5M21 12H10a6 6 0 000 12" transform="scale(-1,1) translate(-24,0)" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" opacity=".9"/>
        </svg>
      </button>
      <button class="icon-btn" id="settingsBtn" aria-label="Opcje">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
          <circle cx="12" cy="5.5" r="1.8" fill="currentColor"/>
          <circle cx="12" cy="12" r="1.8" fill="currentColor"/>
          <circle cx="12" cy="18.5" r="1.8" fill="currentColor"/>
        </svg>
      </button>
    </div>
  </nav>

  <div class="quick-add" id="quickAdd" role="dialog" aria-label="Szybkie dodanie">
    <input id="quickAddInput" type="text" placeholder="Dodaj do bieżącej listy." autocomplete="off" />
    <button class="i-btn" id="quickAddSubmit" aria-label="Dodaj">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
        <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      </svg>
    </button>
    <button class="i-btn" id="quickAddClose" aria-label="Zwiń">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
    </button>
  </div>

  <!-- Add item dialog -->
  <dialog id="addDialog">
    <form id="addForm">
      <div class="dlg-head">
        <div class="dlg-title">Dodaj pozycję</div>
        <button class="btn" type="button" id="addDlgClose" aria-label="Zamknij">Zamknij</button>
      </div>
      <div class="dlg-body">
        <div class="field">
          <div class="label">Treść</div>
          <input type="text" id="addText" placeholder="np. Kupić mleko" required />
        </div>
        <div class="field">
          <div class="label">Dodaj do listy</div>
          <select id="addListSelect"></select>
        </div>
      </div>
      <div class="dlg-foot">
        <button class="btn" type="button" id="addDlgCancel">Anuluj</button>
        <button class="btn primary" id="addSubmitBtn" type="submit">Dodaj</button>
      </div>
    </form>
  </dialog>

  <!-- Settings dialog -->
  <dialog id="settingsDialog">
    <div class="dlg-head">
      <div class="dlg-title">Ustawienia</div>
      <button class="btn" id="closeSettings" type="button">Zamknij</button>
    </div>
    <div class="dlg-body">
      <div class="row">
        <div class="grow">
          <div>Motyw ciemny</div>
          <div class="hint">Przełącz jasny/ciemny</div>
        </div>
        <label class="switch">
          <input type="checkbox" id="darkModeToggle">
          <span class="knob"></span>
        </label>
      </div>

      <div class="row">
        <div class="grow">
          <div>Ukrywaj ukończone</div>
          <div class="hint">W widoku listy ukryj odhaczone pozycje</div>
        </div>
        <label class="switch">
          <input type="checkbox" id="hideCompletedToggle">
          <span class="knob"></span>
        </label>
      </div>

      <div class="row">
        <div class="grow">
          <div>Wibracje przy odhaczaniu</div>
          <div class="hint">Delikatny feedback (jeśli urządzenie wspiera)</div>
        </div>
        <label class="switch">
          <input type="checkbox" id="vibrateToggle">
          <span class="knob"></span>
        </label>
      </div>

      <div class="row" style="gap:10px">
        <button class="btn" id="printBtn" type="button">Drukuj…</button>
        <button class="btn" id="shareBtn" type="button">Udostępnij…</button>
      </div>
    </div>
  </dialog>

  <!-- Manage list dialog -->
  <dialog id="manageDialog">
    <form id="manageForm">
      <div class="dlg-head">
        <div class="dlg-title">Zarządzaj listą</div>
        <button class="btn" type="button" id="manageClose">Zamknij</button>
      </div>
      <div class="dlg-body">
        <div class="field">
          <div class="label">Nazwa listy</div>
          <input type="text" id="manageListName" required maxlength="40" />
          <div class="hint">max 40 znaków</div>
        </div>
        <div class="field">
          <div class="label">Kolor listy</div>
          <div class="swatch-grid" id="managePalette"></div>
          <div class="row">
            <button class="btn" type="button" id="suggestColorsBtn">Losuj z palety</button>
          </div>
          <div class="hint">10 gotowych kolorów – łatwy wybór</div>
        </div>
      </div>
      <div class="dlg-foot" style="justify-content: space-between">
        <button class="btn danger" type="button" id="deleteListBtn">Usuń listę</button>
        <div>
          <button class="btn" type="button" id="manageCancel">Anuluj</button>
          <button class="btn primary" id="saveManageBtn" type="submit">Zapisz</button>
        </div>
      </div>
    </form>
  </dialog>

  <!-- New list dialog -->
  <dialog id="newListDialog">
    <form id="newListForm">
      <div class="dlg-head">
        <div class="dlg-title">Nowa lista</div>
        <button class="btn" type="button" id="newListClose">Zamknij</button>
      </div>
      <div class="dlg-body">
        <div class="field">
          <div class="label">Nazwa</div>
          <input id="newListName" type="text" placeholder="np. Zakupy" required maxlength="40" />
          <div class="hint">max 40 znaków</div>
        </div>
        <div class="field">
          <div class="label">Kolor</div>
          <div class="swatch-grid" id="newListPalette"></div>
          <div class="row">
            <button class="btn" type="button" id="newListRandom">Losuj z palety</button>
          </div>
        </div>
      </div>
      <div class="dlg-foot">
        <button class="btn" type="button" id="newListCancel">Anuluj</button>
        <button class="btn primary" id="createListBtn" type="submit">Utwórz</button>
      </div>
    </form>
  </dialog>

  <!-- Print dialog -->
  <dialog id="printDialog">
    <form id="printForm">
      <div class="dlg-head">
        <div class="dlg-title">Drukuj listy</div>
        <button class="btn" type="button" id="printClose">Zamknij</button>
      </div>
      <div class="dlg-body">
        <div class="field">
          <div class="label">Zaznacz, co drukować</div>
          <div id="printChecks" class="row wrap"></div>
        </div>
        <div class="row">
          <label class="row" style="gap:8px">
            <input type="checkbox" id="printDateToggle" checked>
            <span>Drukuj datę (dziś)</span>
          </label>
        </div>
      </div>
      <div class="dlg-foot">
        <button class="btn" type="button" id="printCancel">Anuluj</button>
        <button class="btn primary" type="submit">Drukuj</button>
      </div>
    </form>
  </dialog>

  <!-- Share dialog -->
  <dialog id="shareDialog">
    <div class="dlg-head">
      <div class="dlg-title">Udostępnij listy</div>
      <button class="btn" type="button" id="shareClose">Zamknij</button>
    </div>
    <div class="dlg-body">
      <div class="field">
        <div class="label">Zaznacz, co udostępnić</div>
        <div id="shareChecks" class="row wrap"></div>
      </div>
      <div class="row">
        <label class="row" style="gap:8px">
          <input type="checkbox" id="shareDateToggle" checked>
          <span>Dołącz datę</span>
        </label>
      </div>
    </div>
    <div class="dlg-foot" style="flex-wrap:wrap">
      <button class="btn" type="button" id="shareCopyBtn">Kopiuj</button>
      <button class="btn" type="button" id="shareWhatsAppBtn">WhatsApp</button>
      <button class="btn primary" type="button" id="shareSystemBtn">Udostępnij systemowo</button>
    </div>
  </dialog>
</div>

<script>
(() => {
  const LS_KEY = 'todoAppData_v5'; // zachowuje Twoje dane
  const el = (id) => document.getElementById(id);
  const $ = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
  const PALETTE10 = ['#4a90e2','#E86B27','#2ecc71','#9b59b6','#e74c3c','#f39c12','#16a085','#d35400','#27ae60','#8e44ad'];
  const NAME_MAX = 40;

  const state = {
    lists: [],
    settings: { dark:false, hideCompleted:false, vibrate:true },
    currentListId: null,
    lastActiveListId: null,
    editMode: false,
  };

  // Historia (cofnij/redo) dla trybu edycji
  const history = {
    listId: null, stack: [], idx: -1, suspend: false, max: 50
  };

  function uid(prefix='id'){ return `${prefix}_${Math.random().toString(36).slice(2,7)}_${Date.now().toString(36)}`; }
  function defaultData(){
    const list1 = { id: uid('list'), name: 'Moja lista 1', color: '#4a90e2', items: [] };
    const list2 = { id: uid('list'), name: 'Moja lista 2', color: '#E86B27', items: [] };
    return { lists: [list1, list2], settings: { dark:false, hideCompleted:false, vibrate:true }, currentListId: list1.id, lastActiveListId: list1.id, editMode: false };
  }
  function save(){ localStorage.setItem(LS_KEY, JSON.stringify({ lists:state.lists, settings:state.settings, currentListId:state.currentListId, lastActiveListId:state.lastActiveListId })); }
  function load(){
    const raw = localStorage.getItem(LS_KEY);
    if(!raw){ Object.assign(state, defaultData()); return; }
    try{
      const data = JSON.parse(raw);
      Object.assign(state, defaultData(), data);
      if(!Array.isArray(state.lists) || state.lists.length === 0){
        const d = defaultData();
        state.lists = d.lists; state.currentListId = d.currentListId; state.lastActiveListId = d.lastActiveListId;
      }
    }catch{ Object.assign(state, defaultData()); }
  }
  function setTheme(dark){ state.settings.dark = !!dark; document.documentElement.setAttribute('data-theme', state.settings.dark ? 'dark' : 'light'); }
  function setAccent(color){ document.documentElement.style.setProperty('--accent', color); document.documentElement.style.setProperty('--accent-soft', hexToRgba(color, 0.14)); }
  function hexToRgba(hex, a=1){ let h = hex.replace('#',''); if(h.length===3){ h = h.split('').map(c=>c+c).join(''); } const r = parseInt(h.slice(0,2),16), g = parseInt(h.slice(2,4),16), b = parseInt(h.slice(4,6),16); return `rgba(${r},${g},${b},${a})`; }
  function vibrate(ms=20){ if(!state.settings.vibrate) return; if('vibrate' in navigator){ try{ navigator.vibrate(ms); }catch{} } }
  function currentList(){ if(state.currentListId === '__completed__') return null; return state.lists.find(l => l.id === state.currentListId) || state.lists[0]; }
  function listById(id){ return state.lists.find(l => l.id === id); }
  function escapeHtml(str=''){ return str.replace(/[&<>"']/g, s=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[s])); }

  function render(){
    document.body.classList.toggle('edit-on', !!state.editMode);
    const isCompletedView = state.currentListId === '__completed__';
    const cl = currentList();
    el('currentListName').textContent = isCompletedView ? 'Zakończone' : (cl?.name || 'Lista');
    const accent = isCompletedView ? '#7a7f8c' : (cl?.color || '#4a90e2');
    setAccent(accent);
    el('listDot').style.background = accent;
    el('listDot').style.boxShadow = `0 0 0 3px ${hexToRgba(accent, .18)}`;

    // Disable add in Zakończone
    el('addBtn').classList.toggle('disabled', isCompletedView);
    el('quickAddBtn').classList.toggle('disabled', isCompletedView);
    if(isCompletedView){ closeQuick(); }

    renderListMenu();
    renderItems();

    el('darkModeToggle').checked = !!state.settings.dark;
    el('hideCompletedToggle').checked = !!state.settings.hideCompleted;
    el('vibrateToggle').checked = !!state.settings.vibrate;

    // Edit & historia
    el('editModeBtn').classList.toggle('active', !!state.editMode);
    updateHistoryButtons();
  }

  function renderListMenu(){
    const cont = el('listMenuItems');
    cont.innerHTML = '';
    let draggingId = null;

    state.lists.forEach((l)=>{
      const btn = document.createElement('div');
      btn.className = 'menu-item'; btn.setAttribute('role', 'button');
      btn.dataset.id = l.id; btn.draggable = true;
      btn.innerHTML = `
        <span class="grip" aria-hidden="true">
          <svg width="16" height="16" viewBox="0 0 24 24"><path d="M9 6h6M9 12h6M9 18h6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        </span>
        <span class="color-dot" style="background:${l.color}"></span>
        <span class="name">${escapeHtml(l.name)}</span>
        <span class="pill">${l.items.filter(i=>!i.done).length}</span>
      `;
      btn.addEventListener('click', ()=>{ state.currentListId = l.id; state.lastActiveListId = l.id; closeMenu(); save(); render(); });
      btn.addEventListener('dragstart', (e)=>{ draggingId = l.id; e.dataTransfer.effectAllowed = 'move'; e.dataTransfer.setData('text/plain', l.id); });
      btn.addEventListener('dragover', (e)=>{ e.preventDefault(); btn.classList.add('drag-over'); });
      btn.addEventListener('dragleave', ()=> btn.classList.remove('drag-over'));
      btn.addEventListener('drop', (e)=>{
        e.preventDefault(); btn.classList.remove('drag-over');
        const fromId = draggingId || e.dataTransfer.getData('text/plain');
        const toId = l.id; if(!fromId || fromId===toId) return;
        const fromIdx = state.lists.findIndex(x=>x.id===fromId);
        const toIdx = state.lists.findIndex(x=>x.id===toId);
        if(fromIdx<0 || toIdx<0) return; moveList(fromIdx, toIdx);
      });
      cont.appendChild(btn);
    });
  }
  function moveList(fromIdx, toIdx){ if(fromIdx===toIdx) return; const [m] = state.lists.splice(fromIdx,1); state.lists.splice(toIdx,0,m); save(); renderListMenu(); }

  function renderItems(){
    const container = el('listContainer');
    container.innerHTML = '';
    const isCompletedView = state.currentListId === '__completed__';
    let items = [], lref = null;

    if(isCompletedView){
      state.lists.forEach(l=> l.items.forEach(it=> { if(it.done) items.push({...it, __fromList: l.id}); }));
      items.sort((a,b)=>(b.completedAt||0)-(a.completedAt||0));
    }else{
      lref = currentList(); if(!lref) return;
      const undone = lref.items.filter(i=>!i.done);
      const done = lref.items.filter(i=>i.done);
      items = state.settings.hideCompleted ? undone : [...undone, ...done];
    }

    // pusty stan (inny dla Zakończone)
    if(items.length === 0){
      el('emptyState').hidden = false;
      el('emptyState').textContent = isCompletedView ? 'Brak pozycji.' : 'Brak pozycji. Dodaj coś przyciskiem +';
      return;
    } else {
      el('emptyState').hidden = true;
    }

    const visibleIds = items.map(i=>i.id);
    const frag = document.createDocumentFragment();

    items.forEach(it=>{
      const li = document.createElement('div');
      li.className = 'item' + (it.done ? ' done' : '') + ' new';
      li.dataset.id = it.id;

      const handle = document.createElement('div');
      handle.className = 'handle';
      handle.innerHTML = `<svg width="20" height="20" viewBox="0 0 24 24"><path d="M9 6h6M9 12h6M9 18h6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>`;

      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.checked = !!it.done;
      checkbox.addEventListener('change', ()=>{
        if(state.currentListId === '__completed__'){
          const listId = findItemListId(it.id) || it.__fromList;
          const l = listById(listId);
          const item = l?.items.find(x=>x.id === it.id);
          if(item){ item.done = checkbox.checked; item.completedAt = item.done ? Date.now() : null; }
        }else{
          const item = lref.items.find(x=>x.id === it.id);
          if(item){ item.done = checkbox.checked; item.completedAt = item.done ? Date.now() : null; }
        }
        vibrate(22); save(); render();
      });

      const texts = document.createElement('div');
      texts.className = 'texts';
      const title = document.createElement('div');
      title.className = 'text';
      title.textContent = it.text;
      texts.appendChild(title);

      if(state.currentListId === '__completed__'){
        const small = document.createElement('div');
        small.className = 'sub';
        const lName = listById(findItemListId(it.id) || it.__fromList)?.name || '—';
        small.textContent = `z listy: ${lName}`;
        texts.appendChild(small);
      }

      const actions = document.createElement('div');
      actions.className = 'actions';
      if(!isCompletedView){
        actions.innerHTML = `
          <button class="i-btn" data-act="up" title="Góra" aria-label="Góra">
            <svg width="16" height="16" viewBox="0 0 24 24"><path d="M6 15l6-6 6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
          </button>
          <button class="i-btn" data-act="down" title="Dół" aria-label="Dół">
            <svg width="16" height="16" viewBox="0 0 24 24"><path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
          </button>
          <button class="i-btn danger" data-act="del" title="Usuń" aria-label="Usuń">
            <svg width="16" height="16" viewBox="0 0 24 24"><path d="M6 7h12M9 7V5h6v2m-8 0l1 12h8l1-12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
          </button>
        `;
        actions.querySelector('[data-act="up"]').addEventListener('click', ()=>{
          const idx = visibleIds.indexOf(it.id);
          if(idx>0){ const visNew = moveInArray(visibleIds.slice(), idx, idx-1); applyVisibleOrder(lref, visNew); }
        });
        actions.querySelector('[data-act="down"]').addEventListener('click', ()=>{
          const idx = visibleIds.indexOf(it.id);
          if(idx>=0 && idx<visibleIds.length-1){ const visNew = moveInArray(visibleIds.slice(), idx, idx+1); applyVisibleOrder(lref, visNew); }
        });
        actions.querySelector('[data-act="del"]').addEventListener('click', ()=>{
          const idx = lref.items.findIndex(x=>x.id===it.id);
          if(idx>=0){ lref.items.splice(idx,1); historyPushIfActive(); vibrate(10); save(); render(); }
        });
      }

      li.appendChild(handle);
      li.appendChild(checkbox);
      li.appendChild(texts);
      li.appendChild(actions);

      if(state.editMode && !isCompletedView){
        title.contentEditable = 'true';
        title.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); title.blur(); } });
        title.addEventListener('blur', ()=>{
          const newVal = (title.textContent || '').trim();
          const idx = lref.items.findIndex(x=>x.id===it.id);
          if(idx>=0){
            if(newVal.length===0){ title.textContent = lref.items[idx].text; return; }
            if(lref.items[idx].text !== newVal){
              lref.items[idx].text = newVal; historyPushIfActive(); save();
            }
          }
        });
        enableItemDrag(li, handle, visibleIds, (visNew)=> applyVisibleOrder(lref, visNew));
      }

      frag.appendChild(li);
    });
    container.appendChild(frag);
  }

  function moveInArray(arr, from, to){ if(from===to) return arr; const [m] = arr.splice(from,1); arr.splice(to,0,m); return arr; }
  function applyVisibleOrder(list, newVisOrder){
    const visQueue = newVisOrder.map(id => list.items.find(i=>i.id===id)).filter(Boolean);
    const isVisible = (it)=> state.settings.hideCompleted ? !it.done : true;
    const out = [];
    for(const it of list.items){ out.push(isVisible(it) ? (visQueue.shift() || it) : it); }
    list.items = out; historyPushIfActive(); vibrate(8); save(); render();
  }

  function enableItemDrag(li, handle, visibleIds, onDropOrder){
    let startY=0, offsetY=0, ph=null, container=null, dragging=false;
    const onPointerDown = (e)=>{
      if(!state.editMode || state.currentListId === '__completed__') return;
      if(e.pointerType === 'mouse' && e.button !== 0) return;
      e.preventDefault(); handle.setPointerCapture?.(e.pointerId);
      container = el('listContainer'); const rect = li.getBoundingClientRect();
      startY = e.clientY; offsetY = startY - rect.top;
      ph = document.createElement('div'); ph.className = 'item placeholder'; ph.style.height = rect.height + 'px';
      container.insertBefore(ph, li.nextSibling);
      li.classList.add('dragging'); li.style.width = rect.width+'px'; li.style.position='fixed'; li.style.left = rect.left+'px'; li.style.top = rect.top+'px'; li.style.zIndex=1000; li.style.pointerEvents='none';
      document.body.style.userSelect='none'; document.body.style.touchAction='none';
      document.addEventListener('pointermove', onPointerMove, {passive:false});
      document.addEventListener('pointerup', onPointerUp, {passive:false});
      dragging = true;
    };
    const onPointerMove = (e)=>{
      if(!dragging) return; e.preventDefault();
      const y = e.clientY - offsetY; li.style.top = y + 'px';
      const centerY = y + li.offsetHeight/2;
      const children = Array.from(container.children).filter(c=>c!==li);
      let newIndex=0; for(let i=0;i<children.length;i++){ const r = children[i].getBoundingClientRect(); if(centerY > r.top + r.height/2) newIndex = i+1; }
      if(container.children[newIndex] !== ph){ container.insertBefore(ph, container.children[newIndex]); }
    };
    const onPointerUp = (e)=>{
      if(!dragging) return; e.preventDefault(); dragging = false;
      document.removeEventListener('pointermove', onPointerMove);
      document.removeEventListener('pointerup', onPointerUp);
      document.body.style.userSelect=''; document.body.style.touchAction='';
      const targetIndex = Array.from(container.children).indexOf(ph); ph.replaceWith(li);
      li.classList.remove('dragging'); li.style.position=''; li.style.left=''; li.style.top=''; li.style.width=''; li.style.zIndex=''; li.style.pointerEvents='';
      const id = li.dataset.id; const from = visibleIds.indexOf(id);
      const to = Math.max(0, Math.min(visibleIds.length-1, targetIndex));
      if(from>=0 && to>=0 && from!==to){ const visNew = moveInArray(visibleIds.slice(), from, to); onDropOrder?.(visNew); }
    };
    handle.addEventListener('pointerdown', onPointerDown);
  }

  function findItemListId(itemId){ for(const l of state.lists){ if(l.items.some(i => i.id === itemId)) return l.id; } return null; }

  // Historia (undo/redo) – snapshoty listy
  function snapshotOfList(list){ return list.items.map(it => ({ id:it.id, text:it.text, done:it.done, createdAt:it.createdAt, completedAt:it.completedAt })); }
  function snapshotsEqual(a,b){
    if(!a || !b || a.length!==b.length) return false;
    for(let i=0;i<a.length;i++){ const x=a[i], y=b[i]; if(x.id!==y.id || x.text!==y.text || x.done!==y.done) return false; }
    return true;
  }
  function historyInit(listId){
    const l = listById(listId); if(!l) return;
    history.listId = listId; history.stack = [ snapshotOfList(l) ]; history.idx = 0; history.suspend = false;
    updateHistoryButtons();
  }
  function historyReset(){ history.listId=null; history.stack=[]; history.idx=-1; history.suspend=false; updateHistoryButtons(); }
  function historyPushIfActive(){
    if(history.suspend) return;
    if(!state.editMode || history.listId !== state.currentListId) return;
    const l = listById(history.listId); if(!l) return;
    const snap = snapshotOfList(l);
    const last = history.stack[history.idx];
    if(snapshotsEqual(snap, last)) return;
    if(history.idx < history.stack.length-1) history.stack = history.stack.slice(0, history.idx+1);
    history.stack.push(snap);
    if(history.stack.length > history.max){ history.stack.shift(); }
    history.idx = history.stack.length - 1;
    updateHistoryButtons();
  }
  function historyApply(idx){
    const l = listById(history.listId); if(!l) return;
    history.suspend = true;
    l.items = history.stack[idx].map(x=> ({...x}));
    history.suspend = false;
    save(); render();
  }
  function historyUndo(){ if(history.idx > 0){ history.idx--; historyApply(history.idx); } }
  function historyRedo(){ if(history.idx < history.stack.length-1){ history.idx++; historyApply(history.idx); } }
  function updateHistoryButtons(){
    const show = state.editMode && history.listId === state.currentListId;
    const undoBtn = el('undoBtn'), redoBtn = el('redoBtn');
    undoBtn.hidden = !show; redoBtn.hidden = !show;
    undoBtn.disabled = !(show && history.idx > 0);
    redoBtn.disabled = !(show && history.idx < history.stack.length-1);
  }

  // Quick add
  const quick = el('quickAdd'); const quickInput = el('quickAddInput');
  function openQuick(){ if(state.currentListId === '__completed__') return; quick.classList.add('open'); setTimeout(()=> quickInput.focus(), 0); }
  function closeQuick(){ quick.classList.remove('open'); quickInput.value = ''; }
  function addItem(text, toListId){
    const l = listById(toListId); if(!l) return;
    l.items.push({ id: uid('it'), text: text.trim(), done:false, createdAt:Date.now(), completedAt:null });
    save(); render();
  }

  // Dialogs/menu
  const menuBtn = el('openMenuBtn'); const menu = el('listMenu');
  function openMenu(){ menu.classList.add('open'); menuBtn.setAttribute('aria-expanded','true'); }
  function closeMenu(){ menu.classList.remove('open'); menuBtn.setAttribute('aria-expanded','false'); }
  menuBtn.addEventListener('click', ()=> menu.classList.contains('open') ? closeMenu() : openMenu());
  document.addEventListener('click', (e)=>{ if(!menu.contains(e.target) && e.target !== menuBtn && !menuBtn.contains(e.target)) closeMenu(); });
  el('completedViewBtn').addEventListener('click', ()=>{ state.currentListId='__completed__'; closeQuick(); closeMenu(); save(); render(); });
  el('manageListBtn').addEventListener('click', ()=>{ closeMenu(); openManage(); });
  el('addListBtn').addEventListener('click', ()=>{ closeMenu(); openNewList(); });

  function openManage(){
    let cl = currentList();
    if(!cl){ const l = listById(state.lastActiveListId) || state.lists[0]; state.currentListId = l.id; cl = l; }
    el('manageListName').value = (cl.name || '').slice(0, NAME_MAX);
    renderPalette(el('managePalette'), cl.color);
    el('manageDialog').showModal();
    setTimeout(()=> el('manageListName').focus(), 0);
  }
  function openNewList(){
    el('newListName').value = '';
    renderPalette(el('newListPalette'), PALETTE10[0]);
    el('newListDialog').showModal();
    setTimeout(()=> el('newListName').focus(), 0);
  }
  function renderPalette(container, currentColor){
    container.innerHTML = '';
    PALETTE10.forEach(c=>{
      const sw = document.createElement('button'); sw.type='button';
      sw.className = 'swatch' + (c.toLowerCase() === (currentColor||'').toLowerCase() ? ' selected' : '');
      sw.style.background = c; sw.dataset.color = c;
      sw.addEventListener('click', ()=>{ $$('.swatch', container).forEach(x=>x.classList.remove('selected')); sw.classList.add('selected'); });
      container.appendChild(sw);
    });
  }
  function getSelectedPaletteColor(container){ const s = $('.swatch.selected', container); return s ? s.dataset.color : PALETTE10[0]; }
  function selectRandomPalette(container){ const idx = Math.floor(Math.random()*PALETTE10.length); $$('.swatch', container).forEach((x,i)=> x.classList.toggle('selected', i===idx)); }
  el('suggestColorsBtn').addEventListener('click', ()=> selectRandomPalette(el('managePalette')));
  el('newListRandom').addEventListener('click', ()=> selectRandomPalette(el('newListPalette')));

  el('manageForm').addEventListener('submit', (e)=>{
    e.preventDefault();
    const cl = currentList(); if(!cl) return;
    const newName = el('manageListName').value.trim().slice(0, NAME_MAX);
    if(newName) cl.name = newName;
    cl.color = getSelectedPaletteColor(el('managePalette')) || cl.color;
    el('manageDialog').close(); save(); render();
  });
  el('manageClose').addEventListener('click', ()=> el('manageDialog').close());
  el('manageCancel').addEventListener('click', ()=> el('manageDialog').close());
  el('deleteListBtn').addEventListener('click', ()=>{
    const cl = currentList(); if(!cl) return;
    if(state.lists.length <= 1){ alert('Musi pozostać przynajmniej jedna lista.'); return; }
    if(confirm(`Usunąć listę "${cl.name}"?`)){
      const idx = state.lists.findIndex(l=>l.id===cl.id);
      if(idx>=0){ state.lists.splice(idx,1); }
      state.currentListId = state.lists[0].id; state.lastActiveListId = state.currentListId;
      el('manageDialog').close(); save(); render();
    }
  });

  el('newListForm').addEventListener('submit', (e)=>{
    e.preventDefault();
    const name = el('newListName').value.trim().slice(0, NAME_MAX);
    if(!name) return;
    const color = getSelectedPaletteColor(el('newListPalette'));
    const l = { id: uid('list'), name, color, items: [] };
    state.lists.push(l);
    state.currentListId = l.id; state.lastActiveListId = l.id;
    el('newListDialog').close(); save(); render();
  });
  el('newListClose').addEventListener('click', ()=> el('newListDialog').close());
  el('newListCancel').addEventListener('click', ()=> el('newListDialog').close());

  // Quick add
  el('quickAddBtn').addEventListener('click', openQuick);
  el('quickAddClose').addEventListener('click', closeQuick);
  el('quickAddSubmit').addEventListener('click', ()=>{
    const txt = quickInput.value.trim(); if(!txt) return;
    const toId = (state.currentListId === '__completed__' ? (state.lastActiveListId || state.lists[0].id) : state.currentListId);
    addItem(txt, toId); quickInput.value = ''; vibrate(12);
  });
  quickInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); el('quickAddSubmit').click(); } else if(e.key==='Escape'){ closeQuick(); } });

  // Add item dialog
  function openAddDialog(){
    if(state.currentListId === '__completed__') return;
    const addListSel = el('addListSelect'); addListSel.innerHTML = '';
    state.lists.forEach(l=>{ const opt = document.createElement('option'); opt.value = l.id; opt.textContent = l.name; addListSel.appendChild(opt); });
    const defaultId = state.currentListId === '__completed__' ? (state.lastActiveListId || state.lists[0].id) : state.currentListId;
    addListSel.value = defaultId; el('addText').value = '';
    el('addDialog').showModal(); setTimeout(()=>el('addText').focus(), 0);
  }
  el('addBtn').addEventListener('click', ()=>{
    if(state.currentListId === '__completed__') return;
    if(state.editMode){ alert('Wyłącz tryb edycji, aby dodać pozycję.'); return; }
    openAddDialog();
  });
  el('addForm').addEventListener('submit', (e)=>{
    e.preventDefault();
    const txt = el('addText').value.trim(); if(!txt) return;
    const listId = el('addListSelect').value;
    addItem(txt, listId); el('addDialog').close(); vibrate(16);
  });
  el('addDlgClose').addEventListener('click', ()=> el('addDialog').close());
  el('addDlgCancel').addEventListener('click', ()=> el('addDialog').close());

  // Settings
  el('settingsBtn').addEventListener('click', ()=> el('settingsDialog').showModal());
  el('closeSettings').addEventListener('click', ()=> el('settingsDialog').close());
  el('darkModeToggle').addEventListener('change', (e)=>{ setTheme(e.target.checked); save(); });
  el('hideCompletedToggle').addEventListener('change', (e)=>{ state.settings.hideCompleted = !!e.target.checked; save(); render(); });
  el('vibrateToggle').addEventListener('change', (e)=>{ state.settings.vibrate = !!e.target.checked; save(); });

  // Drukowanie (checklista + solid iframe onload)
  el('printBtn').addEventListener('click', ()=>{
    const cont = el('printChecks'); cont.innerHTML = '';
    state.lists.forEach(l=>{
      const label = document.createElement('label'); label.className='row'; label.style.gap='8px';
      const cb = document.createElement('input'); cb.type='checkbox'; cb.value = l.id; if(state.currentListId === l.id) cb.checked = true;
      const dot = document.createElement('span'); dot.style.cssText='width:12px;height:12px;border-radius:50%;display:inline-block;background:'+l.color;
      const name = document.createElement('span'); name.textContent = l.name;
      label.appendChild(cb); label.appendChild(dot); label.appendChild(name); cont.appendChild(label);
    });
    const labelC = document.createElement('label'); labelC.className='row'; labelC.style.gap='8px';
    const cbC = document.createElement('input'); cbC.type='checkbox'; cbC.value='__completed__'; if(state.currentListId === '__completed__') cbC.checked = true;
    const dotC = document.createElement('span'); dotC.style.cssText='width:12px;height:12px;border-radius:50%;display:inline-block;background:#7a7f8c';
    const nameC = document.createElement('span'); nameC.textContent = 'Zakończone';
    labelC.appendChild(cbC); labelC.appendChild(dotC); labelC.appendChild(nameC); cont.appendChild(labelC);
    el('printDateToggle').checked = true; el('printDialog').showModal();
  });
  el('printClose').addEventListener('click', ()=> el('printDialog').close());
  el('printCancel').addEventListener('click', ()=> el('printDialog').close());
  el('printForm').addEventListener('submit', (e)=>{
    e.preventDefault();
    const ids = $$('#printChecks input[type="checkbox"]').filter(cb=>cb.checked).map(cb=>cb.value);
    if(ids.length===0){ alert('Zaznacz przynajmniej jedną listę.'); return; }
    const includeDate = el('printDateToggle').checked;
    const html = buildPrintHTML(ids, includeDate);
    el('printDialog').close();
    printUsingIframe(html);
  });

  function buildPrintHTML(ids, includeDate){
    const css = `
      <style>
        @page { margin: 12mm; }
        body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif; color:#111; }
        .pa-date { font-size:12px; color:#555; margin-bottom:8px; }
        .pa-list { margin-bottom:16px; }
        h2 { display:flex; align-items:center; gap:10px; margin: 12px 0 6px; font-size:18px; }
        .pa-dot{ width:12px; height:12px; border-radius:50%; display:inline-block; }
        ul{ margin: 0 0 8px 18px; padding:0; }
        li{ margin:4px 0; }
        .done{ text-decoration: line-through; color:#777; }
      </style>
    `;
    let body = '';
    if(includeDate){
      const d = new Date();
      const dateStr = d.toLocaleDateString('pl-PL', {year:'numeric', month:'2-digit', day:'2-digit'});
      body += `<div class="pa-date">Data: ${dateStr}</div>`;
    }
    ids.forEach(id=>{
      if(id === '__completed__'){
        const allDone = [];
        state.lists.forEach(l=> l.items.forEach(it=>{ if(it.done) allDone.push({text: it.text, from: l.name, completedAt: it.completedAt}); }));
        allDone.sort((a,b)=>(b.completedAt||0)-(a.completedAt||0));
        body += `<div class="pa-list"><h2><span class="pa-dot" style="background:#7a7f8c"></span>Zakończone</h2>`;
        if(allDone.length===0){
          body += `<div>Brak pozycji.</div>`;
        }else{
          body += `<ul>` + allDone.map(it=> `<li>${escapeHtml(it.text)} (z listy: ${escapeHtml(it.from)})</li>`).join('') + `</ul>`;
        }
        body += `</div>`;
      }else{
        const list = listById(id); if(!list) return;
        body += `<div class="pa-list"><h2><span class="pa-dot" style="background:${list.color}"></span>${escapeHtml(list.name)}</h2>`;
        const undone = list.items.filter(i=>!i.done);
        const done = list.items.filter(i=>i.done);
        if(undone.length===0 && done.length===0){
          body += `<div>Brak pozycji.</div>`;
        }else{
          if(undone.length>0){
            body += `<ul>` + undone.map(it=> `<li>${escapeHtml(it.text)}</li>`).join('') + `</ul>`;
          }
          if(done.length>0){
            body += `<div>Ukończone:</div><ul>` + done.map(it=> `<li class="done">${escapeHtml(it.text)}</li>`).join('') + `</ul>`;
          }
        }
        body += `</div>`;
      }
    });
    return `<!DOCTYPE html><html><head><meta charset="utf-8"><title>Drukuj</title>${css}</head><body>${body}</body></html>`;
  }
  function printUsingIframe(html){
    const frame = document.createElement('iframe');
    frame.style.position='fixed'; frame.style.right='0'; frame.style.bottom='0';
    frame.style.width='0'; frame.style.height='0'; frame.style.border='0';
    frame.onload = () => {
      try{ frame.contentWindow.focus(); frame.contentWindow.print(); }
      finally{ setTimeout(()=>{ frame.remove(); }, 1000); }
    };
    document.body.appendChild(frame);
    frame.srcdoc = html;
  }

  // Share
  el('shareBtn').addEventListener('click', ()=>{
    const cont = el('shareChecks'); cont.innerHTML = '';
    state.lists.forEach(l=>{
      const label = document.createElement('label'); label.className='row'; label.style.gap='8px';
      const cb = document.createElement('input'); cb.type='checkbox'; cb.value=l.id; if(state.currentListId === l.id) cb.checked = true;
      const dot = document.createElement('span'); dot.style.cssText='width:12px;height:12px;border-radius:50%;display:inline-block;background:'+l.color;
      const name = document.createElement('span'); name.textContent = l.name;
      label.appendChild(cb); label.appendChild(dot); label.appendChild(name); cont.appendChild(label);
    });
    const labelC = document.createElement('label'); labelC.className='row'; labelC.style.gap='8px';
    const cbC = document.createElement('input'); cbC.type='checkbox'; cbC.value='__completed__'; if(state.currentListId === '__completed__') cbC.checked = true;
    const dotC = document.createElement('span'); dotC.style.cssText='width:12px;height:12px;border-radius:50%;display:inline-block;background:#7a7f8c';
    const nameC = document.createElement('span'); nameC.textContent='Zakończone';
    labelC.appendChild(cbC); labelC.appendChild(dotC); labelC.appendChild(nameC); cont.appendChild(labelC);

    el('shareDateToggle').checked = true;
    el('shareDialog').showModal();
  });
  el('shareClose').addEventListener('click', ()=> el('shareDialog').close());
  el('shareSystemBtn').addEventListener('click', async ()=>{
    const {ids, includeDate} = getShareSelection(); if(ids.length===0){ alert('Zaznacz przynajmniej jedną listę.'); return; }
    const text = buildShareText(ids, includeDate);
    try{
      if(navigator.share){ await navigator.share({ title: 'Lista', text }); }
      else { await copyToClipboard(text); alert('Skopiowano do schowka. Wklej w Messengerze.'); }
    }catch{}
    el('shareDialog').close();
  });
  el('shareWhatsAppBtn').addEventListener('click', ()=>{
    const {ids, includeDate} = getShareSelection(); if(ids.length===0){ alert('Zaznacz przynajmniej jedną listę.'); return; }
    const text = buildShareText(ids, includeDate);
    const mobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
    const base = mobile ? 'https://wa.me/?text=' : 'https://web.whatsapp.com/send?text=';
    window.open(base + encodeURIComponent(text), '_blank'); el('shareDialog').close();
  });
  el('shareCopyBtn').addEventListener('click', async ()=>{
    const {ids, includeDate} = getShareSelection(); if(ids.length===0){ alert('Zaznacz przynajmniej jedną listę.'); return; }
    const text = buildShareText(ids, includeDate);
    await copyToClipboard(text); alert('Skopiowano. Wklej w dowolnej rozmowie.');
  });
  function getShareSelection(){
    const ids = $$('#shareChecks input[type="checkbox"]').filter(cb=>cb.checked).map(cb=>cb.value);
    const includeDate = el('shareDateToggle').checked;
    return {ids, includeDate};
  }
  function buildShareText(ids, includeDate){
    const lines = [];
    if(includeDate){
      const d = new Date(); const dateStr = d.toLocaleDateString('pl-PL', {year:'numeric', month:'2-digit', day:'2-digit'});
      lines.push(`Data: ${dateStr}`);
    }
    ids.forEach(id=>{
      if(id === '__completed__'){
        const allDone = []; state.lists.forEach(l=> l.items.forEach(it=>{ if(it.done) allDone.push({text: it.text, from: l.name, completedAt: it.completedAt}); }));
        allDone.sort((a,b)=>(b.completedAt||0)-(a.completedAt||0));
        lines.push(`\nZakończone:`); if(allDone.length===0){ lines.push(`- (brak)`); } else allDone.forEach(it=> lines.push(`- ${it.text} (z listy: ${it.from})`));
      }else{
        const list = listById(id); if(!list) return;
        lines.push(`\n${list.name}:`);
        const undone = list.items.filter(i=>!i.done), done = list.items.filter(i=>i.done);
        if(undone.length===0 && done.length===0){ lines.push(`- (brak)`); }
        else{
          undone.forEach(it=> lines.push(`- ${it.text}`));
          if(done.length>0){ lines.push(`Ukończone:`); done.forEach(it=> lines.push(`- ${it.text}`)); }
        }
      }
    });
    return lines.join('\n');
  }
  async function copyToClipboard(text){
    try{
      if(navigator.clipboard && window.isSecureContext){ await navigator.clipboard.writeText(text); }
      else{ const ta = document.createElement('textarea'); ta.value = text; ta.style.position='fixed'; ta.style.opacity='0'; document.body.appendChild(ta); ta.focus(); ta.select(); document.execCommand('copy'); ta.remove(); }
    }catch(e){}
  }

  // Edit toggle + undo/redo
  el('editModeBtn').addEventListener('click', ()=>{
    if(state.currentListId === '__completed__'){ alert('Tryb edycji jest dostępny w konkretnej liście.'); return; }
    state.editMode = !state.editMode;
    if(state.editMode){ historyInit(state.currentListId); }
    else{ historyReset(); }
    render();
  });
  el('undoBtn').addEventListener('click', historyUndo);
  el('redoBtn').addEventListener('click', historyRedo);

  // Zamykaj dialogi po kliknięciu tła
  $$('dialog').forEach(d=>{
    d.addEventListener('click', (e)=>{
      const rect = d.getBoundingClientRect();
      const inDialog = e.clientX >= rect.left && e.clientX <= rect.right && e.clientY >= rect.top && e.clientY <= rect.bottom;
      if(!inDialog){ d.close(); }
    });
  });

  // Init
  load(); setTheme(state.settings.dark);
  if(state.currentListId !== '__completed__' && !listById(state.currentListId)){
    state.currentListId = state.lists[0].id; state.lastActiveListId = state.currentListId;
  }
  render();

})();
</script>
</body>
</html>
