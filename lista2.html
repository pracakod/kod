<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Lista • Zadania i Zakupy</title>
<meta name="color-scheme" content="light dark" />
<style>
  :root{
    --bg: #f6f7fb;
    --text: #111318;
    --muted: #566074;
    --card: #ffffff;
    --border: #e6e8f0;
    --accent: #4a90e2;
    --accent-soft: rgba(74,144,226,0.12);
    --shadow: 0 8px 24px rgba(17,19,24,0.08);
    --shadow-soft: 0 4px 12px rgba(17,19,24,0.06);
    --radius: 16px;
    --header-h: 64px;
    --nav-h: 72px;
    --safe-bottom: env(safe-area-inset-bottom);
    --safe-top: env(safe-area-inset-top);
    --focus: 0 0 0 3px rgba(74,144,226,0.3);
    --danger: #d53b3b;
  }
  [data-theme="dark"]{
    --bg: #0c0f14;
    --text: #e6e8ef;
    --muted: #9aa3b2;
    --card: #161a22;
    --border: #232938;
    --shadow: 0 8px 24px rgba(0,0,0,0.45);
    --shadow-soft: 0 4px 12px rgba(0,0,0,0.35);
    --accent-soft: color-mix(in oklab, var(--accent) 15%, transparent);
  }
  *{box-sizing: border-box}
  html,body{height:100%}
  body{
    margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;
    background: var(--bg); color: var(--text); -webkit-tap-highlight-color: transparent;
  }
  button,input,select{font-family:inherit; color:inherit}

  .app{
    min-height:100dvh; display:flex; flex-direction:column; padding-top:var(--safe-top);
  }

  /* Header */
  .app-header{
    position:sticky; top:0; z-index:20; height:var(--header-h);
    backdrop-filter: blur(8px);
    background: linear-gradient(180deg, color-mix(in oklab, var(--accent) 12%, var(--bg)) 0%, var(--bg) 70%);
    border-bottom: 1px solid var(--border);
    display:flex; align-items:center; padding:0 16px;
  }
  .title-button{
    display:flex; align-items:center; gap:10px; padding:10px 12px; border-radius:12px;
    background: var(--card); box-shadow: var(--shadow-soft); border:1px solid var(--border);
    cursor:pointer; user-select:none;
  }
  .title-button:active{transform:scale(0.98)}
  .dot{
    width:10px; height:10px; border-radius:50%; background:var(--accent); box-shadow:0 0 0 3px var(--accent-soft);
  }
  .title-text{font-weight:600}
  .caret{width:16px; height:16px; opacity:0.7}

  /* Dropdown */
  .dropdown{
    position:absolute; top: calc(var(--header-h) - 6px); left:12px; right:12px;
    background: var(--card); border:1px solid var(--border); border-radius:18px;
    box-shadow: var(--shadow); padding:8px; display:none; max-height:60dvh; overflow:auto;
  }
  .dropdown.open{display:block; animation: pop 160ms ease-out}
  @keyframes pop{from{transform:translateY(-8px); opacity:0} to{transform:translateY(0); opacity:1}}

  .menu-sec-title{font-size:12px; color:var(--muted); padding:6px 10px}
  .menu-item{
    display:flex; align-items:center; gap:10px; width:100%; border:0; background:transparent;
    padding:10px; border-radius:12px; cursor:pointer; user-select:none;
  }
  .menu-item:hover{background: color-mix(in oklab, var(--card) 92%, var(--accent) 8%)}
  .menu-item .name{flex:1; text-align:left}
  .pill{background: var(--accent-soft); color: var(--accent); border-radius:999px; font-size:12px; padding:2px 8px}
  .color-dot{width:10px; height:10px; border-radius:50%}
  .grip{opacity:.5; display:grid; place-items:center}
  .menu-arrows{display:flex; gap:6px}
  .menu-item.drag-over{outline:2px dashed var(--accent)}

  /* Main content */
  main{flex:1; padding:12px 12px calc(var(--nav-h) + var(--safe-bottom) + 12px); max-width:900px; width:100%; margin:0 auto}
  .print-header{display:none; font-size:18px; font-weight:700; margin:6px 0 12px}
  .list{ display:grid; gap:8px; }
  .empty{ color:var(--muted); text-align:center; margin-top:18vh; font-size:15px; }

  /* Item */
  .item{
    display:flex; align-items:center; gap:12px; background: var(--card); border:1px solid var(--border);
    padding:12px; border-radius:14px; box-shadow: var(--shadow-soft);
    transition: transform .15s ease, background .2s ease, opacity .2s ease;
  }
  .item.new{animation: slideIn .18s ease-out}
  @keyframes slideIn{from{transform:translateY(8px); opacity:.0} to{transform:translateY(0); opacity:1}}
  .item:active{transform:scale(0.995)}
  .item input[type="checkbox"]{width:22px; height:22px; accent-color: var(--accent); flex-shrink:0}
  .item .texts{display:flex; flex-direction:column; gap:4px; flex:1; min-width:0}
  .item .text{
    font-size:16px; line-height:1.35; word-break:break-word;
    transition: color .2s ease;
  }
  .item.done .text{color: var(--muted); text-decoration: line-through; text-decoration-thickness: 1.5px}
  .sub{color: var(--muted); font-size:12px}

  /* Edit mode */
  .edit-on .item input[type="checkbox"]{display:none}
  .edit-on .item .text{border:1px dashed transparent; border-radius:8px; padding:4px 6px}
  .edit-on .item .text[contenteditable="true"]:focus{border-color: var(--accent); outline:none; box-shadow: var(--focus)}
  .item .handle{
    display:none; width:24px; height:24px; opacity:.55; flex-shrink:0;
  }
  .edit-on .item .handle{display:block}
  .item .actions{display:none; gap:6px; align-items:center}
  .edit-on .item .actions{display:flex}
  .i-btn{
    width:34px; height:34px; display:grid; place-items:center; border-radius:10px; border:1px solid var(--border); background: var(--card);
  }
  .i-btn:active{transform:scale(0.96)}
  .i-btn.danger{color: var(--danger); border-color: color-mix(in oklab, var(--danger) 30%, var(--border)); background: color-mix(in oklab, var(--danger) 10%, var(--card))}

  /* Bottom nav */
  .bottom-nav{
    position:fixed; left:0; right:0; bottom:0; height: calc(var(--nav-h) + var(--safe-bottom));
    padding-bottom: var(--safe-bottom);
    background: var(--card); border-top:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; padding:0 16px; z-index:25;
    gap:12px;
  }
  .icon-btn{
    width:44px; height:44px; border-radius:12px; border:1px solid var(--border); background:var(--card); display:grid; place-items:center;
    box-shadow: var(--shadow-soft);
  }
  .icon-btn:active{transform:scale(0.96)}
  .fab{
    position:absolute; left:50%; transform: translateX(-50%) translateY(-16%);
    width:56px; height:56px; border-radius:50%;
    border:0; background: linear-gradient(135deg, var(--accent), color-mix(in oklab, var(--accent) 60%, #fff));
    color:#fff; display:grid; place-items:center; box-shadow: 0 10px 24px color-mix(in oklab, var(--accent) 30%, transparent);
  }
  .fab:active{transform: translateX(-50%) translateY(-16%) scale(0.97)}
  .icon-btn.active{outline:2px solid var(--accent); outline-offset:2px}

  /* Quick add */
  .quick-add{
    position: fixed; left:12px; right:12px; bottom: calc(var(--nav-h) + var(--safe-bottom) + 10px);
    background: var(--card); border:1px solid var(--border); border-radius:14px; box-shadow: var(--shadow);
    display:none; padding:8px; gap:8px; align-items:center;
  }
  .quick-add.open{display:flex; animation: pop .12s ease-out}
  .quick-add input{
    flex:1; border:0; background:transparent; outline:none; padding:10px; border-radius:10px;
  }

  /* Dialogs */
  dialog{
    border:0; border-radius:18px; padding:0; background: var(--card); color: var(--text); width:min(520px, 92vw);
    box-shadow: var(--shadow);
  }
  dialog::backdrop{background: rgba(10,12,16,0.45); backdrop-filter: blur(3px)}
  .dlg-head{padding:16px 18px; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between}
  .dlg-title{font-weight:700}
  .dlg-body{padding:14px 18px; display:grid; gap:12px}
  .field{display:grid; gap:6px}
  .label{font-size:13px; color:var(--muted)}
  input[type="text"], select{
    width:100%; border:1px solid var(--border); background: var(--card); color: var(--text);
    border-radius:12px; padding:12px; outline:none;
  }
  .row{display:flex; gap:10px; align-items:center}
  .row.wrap{flex-wrap:wrap}
  .grow{flex:1}
  .switch{
    position:relative; width:48px; height:28px; background: var(--border); border-radius:999px; cursor:pointer; border:1px solid var(--border);
  }
  .switch input{display:none}
  .switch .knob{
    position:absolute; top:50%; left:4px; transform:translateY(-50%); width:20px; height:20px; border-radius:50%;
    background:#fff; box-shadow: var(--shadow-soft); transition: left .18s ease, background .18s ease;
  }
  .switch input:checked + .knob{ left:24px; background: var(--accent)}
  .dlg-foot{display:flex; gap:10px; justify-content:flex-end; padding:14px 18px; border-top:1px solid var(--border)}
  .btn{ padding:10px 14px; border-radius:12px; border:1px solid var(--border); background:var(--card); cursor:pointer; }
  .btn.primary{ background: var(--accent); border-color: transparent; color:#fff; }
  .btn.danger{color:var(--danger); border-color: color-mix(in oklab, var(--danger) 30%, var(--border)); background: color-mix(in oklab, var(--danger) 10%, var(--card))}
  .hint{font-size:12px; color:var(--muted)}

  /* Color palette (10 kolorów) */
  .swatch-grid{display:grid; grid-template-columns: repeat(10, 1fr); gap:8px}
  .swatch{
    width:28px; height:28px; border-radius:999px; border:2px solid #fff; box-shadow: 0 0 0 2px var(--border); cursor:pointer;
  }
  .swatch.selected{box-shadow: 0 0 0 2px var(--accent)}

  /* Print */
  @media print{
    .app-header, .bottom-nav, .dropdown, .quick-add, dialog{display:none !important}
    main{padding:0}
    body{background:#fff}
    .print-header{display:block}
    .item{box-shadow:none; border:1px solid #ddd}
  }

  /* Reduced motion */
  @media (prefers-reduced-motion: reduce){
    *{animation:none !important; transition:none !important}
  }
</style>
</head>
<body>
<div class="app" id="app">
  <header class="app-header">
    <button class="title-button" id="openMenuBtn" aria-haspopup="true" aria-expanded="false">
      <span class="dot" id="listDot"></span>
      <span class="title-text" id="currentListName">Moja lista</span>
      <svg class="caret" viewBox="0 0 24 24" fill="none" aria-hidden="true">
        <path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>

    <div class="dropdown" id="listMenu" role="menu" aria-label="Wybierz listę">
      <div class="menu-sec">
        <div class="menu-sec-title">Moje listy <span class="hint">• przeciągaj aby zmienić kolejność</span></div>
        <div id="listMenuItems"></div>
      </div>
      <div class="menu-sec">
        <div class="menu-sec-title">Inne</div>
        <button class="menu-item" id="completedViewBtn">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
            <path d="M20 12a8 8 0 11-16 0 8 8 0 0116 0z" stroke="currentColor" stroke-width="2"/>
            <path d="M9 12l2 2 4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <span class="name">Zakończone</span>
        </button>
      </div>
      <div class="menu-sec">
        <button class="menu-item" id="manageListBtn">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
            <path d="M12 15a3 3 0 100-6 3 3 0 000 6z" stroke="currentColor" stroke-width="2"/>
            <path d="M19.5 12a7.5 7.5 0 10-15 0 7.5 7.5 0 0015 0z" stroke="currentColor" stroke-width="1.4" opacity=".4"/>
          </svg>
          <span class="name">Zarządzaj listą</span>
        </button>
        <button class="menu-item" id="addListBtn">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
            <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
          <span class="name">Nowa lista</span>
        </button>
      </div>
    </div>
  </header>

  <main>
    <div id="printHeader" class="print-header"></div>
    <div id="listContainer" class="list"></div>
    <div id="emptyState" class="empty" hidden>Brak pozycji. Dodaj coś przyciskiem +</div>
  </main>

  <nav class="bottom-nav">
    <button class="icon-btn" id="quickAddBtn" aria-label="Szybkie dodanie">
      <!-- add icon -->
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
        <path d="M5 12h14M12 5v14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      </svg>
    </button>

    <button class="fab" id="addBtn" aria-label="Dodaj">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
        <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      </svg>
    </button>

    <button class="icon-btn" id="editModeBtn" aria-label="Tryb edycji">
      <!-- pencil -->
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
        <path d="M15.2 5.2l3.6 3.6M7 17l-1 4 4-1 9.6-9.6a2.5 2.5 0 00-3.6-3.6L7 17z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>

    <button class="icon-btn" id="settingsBtn" aria-label="Ustawienia">
      <!-- improved cog -->
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden="true">
        <path d="M12 15.5a3.5 3.5 0 100-7 3.5 3.5 0 000 7z" stroke="currentColor" stroke-width="2"/>
        <path d="M19.5 12l1.8-.6a8.1 8.1 0 00-.3-1l-1.7.3a6.7 6.7 0 00-.9-1.5l1.1-1.3a8.1 8.1 0 00-.8-.8L16.5 7a6.7 6.7 0 00-1.5-.9l.3-1.7a8.1 8.1 0 00-1-.3L12 3.5l-.6-1.8a8.1 8.1 0 00-1 .3l.3 1.7a6.7 6.7 0 00-1.5.9L7.9 2.9a8.1 8.1 0 00-.8.8L8.4 5a6.7 6.7 0 00-.9 1.5l-1.7-.3a8.1 8.1 0 00-.3 1L5.5 12l-1.8.6a8.1 8.1 0 00.3 1l1.7-.3a6.7 6.7 0 00.9 1.5l-1.1 1.3c.26.3.53.57.83.83L7.5 16a6.7 6.7 0 001.5.9l-.3 1.7c.32.1.66.2 1 .3L12 20.5l.6 1.8c.34-.08.68-.18 1-.3l-.3-1.7a6.7 6.7 0 001.5-.9l1.3 1.1c.3-.26.57-.53.83-.83L16 16.5a6.7 6.7 0 00.9-1.5l1.7.3c.1-.32.2-.66.3-1L19.5 12z" stroke="currentColor" stroke-width="1.2" opacity=".7"/>
      </svg>
    </button>
  </nav>

  <div class="quick-add" id="quickAdd" role="dialog" aria-label="Szybkie dodanie">
    <input id="quickAddInput" type="text" placeholder="Szybko dodaj do bieżącej listy… (Enter = dodaj)" autocomplete="off" />
    <button class="i-btn" id="quickAddSubmit" aria-label="Dodaj">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
        <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      </svg>
    </button>
    <button class="i-btn" id="quickAddClose" aria-label="Zwiń">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
    </button>
  </div>

  <!-- Add item dialog -->
  <dialog id="addDialog">
    <form id="addForm">
      <div class="dlg-head">
        <div class="dlg-title">Dodaj pozycję</div>
        <button class="btn" type="button" id="addDlgClose" aria-label="Zamknij">Zamknij</button>
      </div>
      <div class="dlg-body">
        <div class="field">
          <div class="label">Treść</div>
          <input type="text" id="addText" placeholder="np. Kupić mleko" required />
        </div>
        <div class="field">
          <div class="label">Dodaj do listy</div>
          <select id="addListSelect"></select>
        </div>
      </div>
      <div class="dlg-foot">
        <button class="btn" type="button" id="addDlgCancel">Anuluj</button>
        <button class="btn primary" id="addSubmitBtn" type="submit">Dodaj</button>
      </div>
    </form>
  </dialog>

  <!-- Settings dialog -->
  <dialog id="settingsDialog">
    <div class="dlg-head">
      <div class="dlg-title">Ustawienia</div>
      <button class="btn" id="closeSettings" type="button">Zamknij</button>
    </div>
    <div class="dlg-body">
      <div class="row">
        <div class="grow">
          <div>Motyw ciemny</div>
          <div class="hint">Przełącz jasny/ciemny</div>
        </div>
        <label class="switch">
          <input type="checkbox" id="darkModeToggle">
          <span class="knob"></span>
        </label>
      </div>

      <div class="row">
        <div class="grow">
          <div>Ukrywaj ukończone</div>
          <div class="hint">W widoku listy ukryj odhaczone pozycje</div>
        </div>
        <label class="switch">
          <input type="checkbox" id="hideCompletedToggle">
          <span class="knob"></span>
        </label>
      </div>

      <div class="row">
        <div class="grow">
          <div>Wibracje przy odhaczaniu</div>
          <div class="hint">Delikatny feedback (jeśli urządzenie wspiera)</div>
        </div>
        <label class="switch">
          <input type="checkbox" id="vibrateToggle">
          <span class="knob"></span>
        </label>
      </div>

      <div class="row">
        <button class="btn" id="printBtn" type="button">Drukuj…</button>
      </div>
    </div>
  </dialog>

  <!-- Manage list dialog -->
  <dialog id="manageDialog">
    <form id="manageForm">
      <div class="dlg-head">
        <div class="dlg-title">Zarządzaj listą</div>
        <button class="btn" type="button" id="manageClose">Zamknij</button>
      </div>
      <div class="dlg-body">
        <div class="field">
          <div class="label">Nazwa listy</div>
          <input type="text" id="manageListName" required maxlength="40" />
          <div class="hint">max 40 znaków</div>
        </div>
        <div class="field">
          <div class="label">Kolor listy</div>
          <div class="swatch-grid" id="managePalette"></div>
          <div class="row">
            <button class="btn" type="button" id="suggestColorsBtn">Losuj z palety</button>
          </div>
          <div class="hint">10 gotowych kolorów – łatwy wybór</div>
        </div>
      </div>
      <div class="dlg-foot" style="justify-content: space-between">
        <button class="btn danger" type="button" id="deleteListBtn">Usuń listę</button>
        <div>
          <button class="btn" type="button" id="manageCancel">Anuluj</button>
          <button class="btn primary" id="saveManageBtn" type="submit">Zapisz</button>
        </div>
      </div>
    </form>
  </dialog>

  <!-- New list dialog -->
  <dialog id="newListDialog">
    <form id="newListForm">
      <div class="dlg-head">
        <div class="dlg-title">Nowa lista</div>
        <button class="btn" type="button" id="newListClose">Zamknij</button>
      </div>
      <div class="dlg-body">
        <div class="field">
          <div class="label">Nazwa</div>
          <input id="newListName" type="text" placeholder="np. Zakupy" required maxlength="40" />
          <div class="hint">max 40 znaków</div>
        </div>
        <div class="field">
          <div class="label">Kolor</div>
          <div class="swatch-grid" id="newListPalette"></div>
          <div class="row">
            <button class="btn" type="button" id="newListRandom">Losuj z palety</button>
          </div>
        </div>
      </div>
      <div class="dlg-foot">
        <button class="btn" type="button" id="newListCancel">Anuluj</button>
        <button class="btn primary" id="createListBtn" type="submit">Utwórz</button>
      </div>
    </form>
  </dialog>

  <!-- Print dialog -->
  <dialog id="printDialog">
    <form id="printForm">
      <div class="dlg-head">
        <div class="dlg-title">Drukuj listę</div>
        <button class="btn" type="button" id="printClose">Zamknij</button>
      </div>
      <div class="dlg-body">
        <div class="field">
          <div class="label">Wybierz listę do druku</div>
          <select id="printListSelect"></select>
        </div>
      </div>
      <div class="dlg-foot">
        <button class="btn" type="button" id="printCancel">Anuluj</button>
        <button class="btn primary" type="submit">Drukuj</button>
      </div>
    </form>
  </dialog>
</div>

<script>
(() => {
  const LS_KEY = 'todoAppData_v2';

  const el = (id) => document.getElementById(id);
  const $ = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

  const PALETTE10 = ['#4a90e2','#E86B27','#2ecc71','#9b59b6','#e74c3c','#f39c12','#16a085','#d35400','#27ae60','#8e44ad'];
  const NAME_MAX = 40;

  const state = {
    lists: [],
    settings: {
      dark: false,
      hideCompleted: false,
      vibrate: true,
    },
    currentListId: null, // actual list id or '__completed__'
    lastActiveListId: null,
    editMode: false,
  };

  function uid(prefix='id'){
    return `${prefix}_${Math.random().toString(36).slice(2,7)}_${Date.now().toString(36)}`;
  }

  function defaultData(){
    const list1 = { id: uid('list'), name: 'Moja lista 1', color: '#4a90e2', items: [] };
    const list2 = { id: uid('list'), name: 'Moja lista 2', color: '#E86B27', items: [] };
    return {
      lists: [list1, list2],
      settings: { dark: false, hideCompleted: false, vibrate: true },
      currentListId: list1.id,
      lastActiveListId: list1.id,
      editMode: false,
    };
  }

  function save(){
    const toSave = {
      lists: state.lists,
      settings: state.settings,
      currentListId: state.currentListId,
      lastActiveListId: state.lastActiveListId,
    };
    localStorage.setItem(LS_KEY, JSON.stringify(toSave));
  }

  function load(){
    const raw = localStorage.getItem(LS_KEY);
    if(!raw){
      Object.assign(state, defaultData());
      return;
    }
    try{
      const data = JSON.parse(raw);
      Object.assign(state, defaultData(), data); // fill defaults if missing
      if(!Array.isArray(state.lists) || state.lists.length === 0){
        const d = defaultData();
        state.lists = d.lists;
        state.currentListId = d.currentListId;
        state.lastActiveListId = d.lastActiveListId;
      }
    }catch{
      Object.assign(state, defaultData());
    }
  }

  function setTheme(dark){
    state.settings.dark = !!dark;
    document.documentElement.setAttribute('data-theme', state.settings.dark ? 'dark' : 'light');
  }

  function setAccent(color){
    document.documentElement.style.setProperty('--accent', color);
    document.documentElement.style.setProperty('--accent-soft', hexToRgba(color, 0.14));
  }

  function currentList(){
    if(state.currentListId === '__completed__') return null;
    return state.lists.find(l => l.id === state.currentListId) || state.lists[0];
  }

  function listById(id){
    return state.lists.find(l => l.id === id);
  }

  function hexToRgba(hex, a=1){
    let h = hex.replace('#','');
    if(h.length===3){ h = h.split('').map(c=>c+c).join(''); }
    const r = parseInt(h.slice(0,2),16);
    const g = parseInt(h.slice(2,4),16);
    const b = parseInt(h.slice(4,6),16);
    return `rgba(${r},${g},${b},${a})`;
  }

  function vibrate(ms=20){
    if(!state.settings.vibrate) return;
    if('vibrate' in navigator){
      try{ navigator.vibrate(ms); }catch{}
    }
  }

  function render(){
    document.body.classList.toggle('edit-on', !!state.editMode);

    const isCompletedView = state.currentListId === '__completed__';
    const cl = currentList();
    el('currentListName').textContent = isCompletedView ? 'Zakończone' : (cl?.name || 'Lista');
    const accent = isCompletedView ? '#7a7f8c' : (cl?.color || '#4a90e2');
    setAccent(accent);
    el('listDot').style.background = accent;
    el('listDot').style.boxShadow = `0 0 0 3px ${hexToRgba(accent, .18)}`;

    renderListMenu();
    renderItems();

    // Settings toggles
    el('darkModeToggle').checked = !!state.settings.dark;
    el('hideCompletedToggle').checked = !!state.settings.hideCompleted;
    el('vibrateToggle').checked = !!state.settings.vibrate;

    // Edit button state
    el('editModeBtn').classList.toggle('active', !!state.editMode);

    // Print header (set text; visible only in @media print)
    const ph = el('printHeader');
    ph.textContent = isCompletedView ? 'Zakończone' : (cl?.name || '');
  }

  function renderListMenu(){
    const cont = el('listMenuItems');
    cont.innerHTML = '';
    const frag = document.createDocumentFragment();

    let draggingId = null;

    state.lists.forEach((l, idx)=>{
      const btn = document.createElement('div');
      btn.className = 'menu-item';
      btn.setAttribute('role', 'button');
      btn.dataset.id = l.id;
      btn.draggable = true;

      btn.innerHTML = `
        <span class="grip" aria-hidden="true">
          <svg width="16" height="16" viewBox="0 0 24 24"><path d="M9 6h6M9 12h6M9 18h6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        </span>
        <span class="color-dot" style="background:${l.color}"></span>
        <span class="name">${escapeHtml(l.name)}</span>
        <span class="pill">${l.items.filter(i=>!i.done).length}</span>
        <span class="menu-arrows">
          <button class="i-btn" data-act="up" title="Góra" aria-label="Góra">
            <svg width="16" height="16" viewBox="0 0 24 24"><path d="M6 15l6-6 6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
          </button>
          <button class="i-btn" data-act="down" title="Dół" aria-label="Dół">
            <svg width="16" height="16" viewBox="0 0 24 24"><path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
          </button>
        </span>
      `;

      // Click select
      btn.addEventListener('click', (e)=>{
        if(e.target.closest('.i-btn')) return; // ignore arrow clicks
        state.currentListId = l.id;
        state.lastActiveListId = l.id;
        closeMenu();
        save(); render();
      });

      // Up/down fallback (mobile-friendly)
      btn.querySelector('[data-act="up"]').addEventListener('click', (e)=>{
        e.stopPropagation();
        moveList(idx, Math.max(0, idx-1));
      });
      btn.querySelector('[data-act="down"]').addEventListener('click', (e)=>{
        e.stopPropagation();
        moveList(idx, Math.min(state.lists.length-1, idx+1));
      });

      // Drag & drop reorder
      btn.addEventListener('dragstart', (e)=>{
        draggingId = l.id;
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', l.id);
      });
      btn.addEventListener('dragover', (e)=>{
        e.preventDefault();
        btn.classList.add('drag-over');
      });
      btn.addEventListener('dragleave', ()=>{
        btn.classList.remove('drag-over');
      });
      btn.addEventListener('drop', (e)=>{
        e.preventDefault();
        btn.classList.remove('drag-over');
        const fromId = draggingId || e.dataTransfer.getData('text/plain');
        const toId = l.id;
        if(!fromId || fromId===toId) return;
        const fromIdx = state.lists.findIndex(x=>x.id===fromId);
        const toIdx = state.lists.findIndex(x=>x.id===toId);
        if(fromIdx<0 || toIdx<0) return;
        moveList(fromIdx, toIdx);
      });

      frag.appendChild(btn);
    });
    cont.appendChild(frag);
  }

  function moveList(fromIdx, toIdx){
    if(fromIdx===toIdx) return;
    const [m] = state.lists.splice(fromIdx, 1);
    state.lists.splice(toIdx, 0, m);
    save();
    renderListMenu();
  }

  function renderItems(){
    const container = el('listContainer');
    container.innerHTML = '';
    const isCompletedView = state.currentListId === '__completed__';
    let items = [];
    let lref = null;

    if(isCompletedView){
      state.lists.forEach(l=>{
        l.items.forEach(it=>{
          if(it.done){ items.push({...it, __fromList: l.id}); }
        });
      });
      items.sort((a,b)=>(b.completedAt||0) - (a.completedAt||0));
    }else{
      lref = currentList();
      if(!lref) return;
      const undone = lref.items.filter(i=>!i.done).sort((a,b)=> (a.createdAt||0) - (b.createdAt||0));
      const done = lref.items.filter(i=>i.done).sort((a,b)=> (a.completedAt||0) - (b.completedAt||0));
      items = state.settings.hideCompleted ? undone : [...undone, ...done];
    }

    el('emptyState').hidden = items.length !== 0;

    const frag = document.createDocumentFragment();
    items.forEach(it=>{
      const li = document.createElement('div');
      li.className = 'item' + (it.done ? ' done' : '') + ' new';

      const handle = document.createElement('div');
      handle.className = 'handle';
      handle.innerHTML = `<svg width="20" height="20" viewBox="0 0 24 24"><path d="M9 6h6M9 12h6M9 18h6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>`;

      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.checked = !!it.done;
      checkbox.addEventListener('change', ()=>{
        if(state.currentListId === '__completed__'){
          const listId = findItemListId(it.id) || it.__fromList;
          const l = listById(listId);
          const item = l?.items.find(x=>x.id === it.id);
          if(item){
            item.done = checkbox.checked;
            item.completedAt = item.done ? Date.now() : null;
          }
        }else{
          const item = lref.items.find(x=>x.id === it.id);
          if(item){
            item.done = checkbox.checked;
            item.completedAt = item.done ? Date.now() : null;
          }
        }
        vibrate(22);
        save(); render();
      });

      const texts = document.createElement('div');
      texts.className = 'texts';
      const title = document.createElement('div');
      title.className = 'text';
      title.textContent = it.text;
      texts.appendChild(title);

      if(state.currentListId === '__completed__'){
        const small = document.createElement('div');
        small.className = 'sub';
        const lName = listById(findItemListId(it.id) || it.__fromList)?.name || '—';
        small.textContent = `z listy: ${lName}`;
        texts.appendChild(small);
      }

      // Edit mode: allow rename, move up/down, delete (only on concrete list view)
      const actions = document.createElement('div');
      actions.className = 'actions';
      if(!isCompletedView){
        actions.innerHTML = `
          <button class="i-btn" data-act="up" title="Góra" aria-label="Góra">
            <svg width="16" height="16" viewBox="0 0 24 24"><path d="M6 15l6-6 6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
          </button>
          <button class="i-btn" data-act="down" title="Dół" aria-label="Dół">
            <svg width="16" height="16" viewBox="0 0 24 24"><path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
          </button>
          <button class="i-btn danger" data-act="del" title="Usuń" aria-label="Usuń">
            <svg width="16" height="16" viewBox="0 0 24 24"><path d="M6 7h12M9 7V5h6v2m-8 0l1 12h8l1-12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
          </button>
        `;
        actions.querySelector('[data-act="up"]').addEventListener('click', ()=>{
          const idx = lref.items.findIndex(x=>x.id===it.id);
          if(idx>0){ moveItem(lref, idx, idx-1); }
        });
        actions.querySelector('[data-act="down"]').addEventListener('click', ()=>{
          const idx = lref.items.findIndex(x=>x.id===it.id);
          if(idx>=0 && idx<lref.items.length-1){ moveItem(lref, idx, idx+1); }
        });
        actions.querySelector('[data-act="del"]').addEventListener('click', ()=>{
          const idx = lref.items.findIndex(x=>x.id===it.id);
          if(idx>=0){
            lref.items.splice(idx,1);
            vibrate(10);
            save(); render();
          }
        });
      }

      li.appendChild(handle);
      li.appendChild(checkbox);
      li.appendChild(texts);
      li.appendChild(actions);

      // Enable contenteditable in edit mode (only non-completed view)
      if(state.editMode && !isCompletedView){
        title.contentEditable = 'true';
        title.addEventListener('keydown', (e)=>{
          if(e.key==='Enter'){
            e.preventDefault(); title.blur();
          }
        });
        title.addEventListener('blur', ()=>{
          const newVal = (title.textContent || '').trim();
          const idx = lref.items.findIndex(x=>x.id===it.id);
          if(idx>=0){
            if(newVal.length===0){ // empty -> revert to old
              title.textContent = lref.items[idx].text;
              return;
            }
            lref.items[idx].text = newVal;
            save();
          }
        });
      }

      frag.appendChild(li);
    });
    container.appendChild(frag);
  }

  function moveItem(list, fromIdx, toIdx){
    if(fromIdx===toIdx) return;
    const [m] = list.items.splice(fromIdx,1);
    list.items.splice(toIdx,0,m);
    vibrate(8);
    save(); render();
  }

  function findItemListId(itemId){
    for(const l of state.lists){
      if(l.items.some(i => i.id === itemId)) return l.id;
    }
    return null;
  }

  function escapeHtml(str=''){
    return str.replace(/[&<>"']/g, s=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[s]));
  }

  // Quick add
  const quick = el('quickAdd');
  const quickInput = el('quickAddInput');
  function openQuick(){
    quick.classList.add('open');
    setTimeout(()=> quickInput.focus(), 0);
  }
  function closeQuick(){
    quick.classList.remove('open');
    quickInput.value = '';
  }

  function addItem(text, toListId){
    const l = listById(toListId);
    if(!l) return;
    l.items.push({
      id: uid('it'),
      text: text.trim(),
      done: false,
      createdAt: Date.now(),
      completedAt: null
    });
    save();
    render();
  }

  function openAddDialog(){
    // Fill select
    const addListSel = el('addListSelect');
    addListSel.innerHTML = '';
    state.lists.forEach(l=>{
      const opt = document.createElement('option');
      opt.value = l.id; opt.textContent = l.name;
      addListSel.appendChild(opt);
    });
    // Default to current (or last active if in "Zakończone")
    const defaultId = state.currentListId === '__completed__' ? (state.lastActiveListId || state.lists[0].id) : state.currentListId;
    addListSel.value = defaultId;
    el('addText').value = '';
    el('addDialog').showModal();
    setTimeout(()=>el('addText').focus(), 0);
  }

  // Color palette helpers
  function renderPalette(container, currentColor){
    container.innerHTML = '';
    PALETTE10.forEach(c=>{
      const sw = document.createElement('button');
      sw.type = 'button';
      sw.className = 'swatch' + (c.toLowerCase() === (currentColor||'').toLowerCase() ? ' selected' : '');
      sw.style.background = c;
      sw.dataset.color = c;
      sw.addEventListener('click', ()=>{
        $$('.swatch', container).forEach(x=>x.classList.remove('selected'));
        sw.classList.add('selected');
      });
      container.appendChild(sw);
    });
  }
  function getSelectedPaletteColor(container){
    const s = $('.swatch.selected', container);
    return s ? s.dataset.color : PALETTE10[0];
  }
  function selectRandomPalette(container){
    const idx = Math.floor(Math.random()*PALETTE10.length);
    $$('.swatch', container).forEach((x,i)=> x.classList.toggle('selected', i===idx));
  }

  // Menu open/close
  const menuBtn = el('openMenuBtn');
  const menu = el('listMenu');
  function openMenu(){
    menu.classList.add('open'); menuBtn.setAttribute('aria-expanded','true');
  }
  function closeMenu(){
    menu.classList.remove('open'); menuBtn.setAttribute('aria-expanded','false');
  }

  // Event bindings
  menuBtn.addEventListener('click', ()=>{
    const open = menu.classList.contains('open');
    if(open) closeMenu(); else openMenu();
  });
  document.addEventListener('click', (e)=>{
    if(!menu.contains(e.target) && e.target !== menuBtn && !menuBtn.contains(e.target)){
      closeMenu();
    }
  });

  el('completedViewBtn').addEventListener('click', ()=>{
    state.currentListId = '__completed__';
    closeMenu(); save(); render();
  });

  el('manageListBtn').addEventListener('click', ()=>{
    closeMenu(); openManage();
  });

  el('addListBtn').addEventListener('click', ()=>{
    closeMenu();
    openNewList();
  });

  function openManage(){
    let cl = currentList();
    if(!cl){
      const l = listById(state.lastActiveListId) || state.lists[0];
      state.currentListId = l.id;
      cl = l;
    }
    const manageName = el('manageListName');
    const managePalette = el('managePalette');
    manageName.value = (cl.name || '').slice(0, NAME_MAX);
    renderPalette(managePalette, cl.color);
    el('manageDialog').showModal();
    setTimeout(()=> manageName.focus(), 0);
  }

  function openNewList(){
    const newName = el('newListName');
    const pal = el('newListPalette');
    newName.value = '';
    renderPalette(pal, PALETTE10[0]);
    el('newListDialog').showModal();
    setTimeout(()=> newName.focus(), 0);
  }

  el('suggestColorsBtn').addEventListener('click', ()=>{
    selectRandomPalette(el('managePalette'));
  });

  el('newListRandom').addEventListener('click', ()=>{
    selectRandomPalette(el('newListPalette'));
  });

  // Manage dialog actions
  el('manageForm').addEventListener('submit', (e)=>{
    e.preventDefault();
    const cl = currentList();
    if(!cl) return;
    const newName = el('manageListName').value.trim().slice(0, NAME_MAX);
    if(newName) cl.name = newName;
    cl.color = getSelectedPaletteColor(el('managePalette')) || cl.color;
    el('manageDialog').close();
    save(); render();
  });
  el('manageClose').addEventListener('click', ()=> el('manageDialog').close());
  el('manageCancel').addEventListener('click', ()=> el('manageDialog').close());
  el('deleteListBtn').addEventListener('click', ()=>{
    const cl = currentList();
    if(!cl) return;
    if(state.lists.length <= 1){
      alert('Musi pozostać przynajmniej jedna lista.');
      return;
    }
    if(confirm(`Usunąć listę "${cl.name}"?`)){
      const idx = state.lists.findIndex(l=>l.id===cl.id);
      if(idx>=0){ state.lists.splice(idx,1); }
      state.currentListId = state.lists[0].id;
      state.lastActiveListId = state.currentListId;
      el('manageDialog').close();
      save(); render();
    }
  });

  // New list dialog actions
  el('newListForm').addEventListener('submit', (e)=>{
    e.preventDefault();
    const name = el('newListName').value.trim().slice(0, NAME_MAX);
    if(!name) return;
    const color = getSelectedPaletteColor(el('newListPalette'));
    const l = { id: uid('list'), name, color, items: [] };
    state.lists.push(l);
    state.currentListId = l.id;
    state.lastActiveListId = l.id;
    el('newListDialog').close();
    save(); render();
  });
  el('newListClose').addEventListener('click', ()=> el('newListDialog').close());
  el('newListCancel').addEventListener('click', ()=> el('newListDialog').close());

  // Quick add
  el('quickAddBtn').addEventListener('click', openQuick);
  el('quickAddClose').addEventListener('click', closeQuick);
  el('quickAddSubmit').addEventListener('click', ()=>{
    const txt = quickInput.value.trim();
    if(!txt) return;
    const toId = (state.currentListId === '__completed__' ? (state.lastActiveListId || state.lists[0].id) : state.currentListId);
    addItem(txt, toId);
    quickInput.value = '';
    vibrate(12);
  });
  quickInput.addEventListener('keydown', (e)=>{
    if(e.key === 'Enter'){
      e.preventDefault();
      el('quickAddSubmit').click();
    }else if(e.key==='Escape'){ closeQuick(); }
  });

  // Add item dialog
  el('addBtn').addEventListener('click', ()=>{
    if(state.editMode){
      alert('Wyłącz tryb edycji, aby dodać pozycję.');
      return;
    }
    openAddDialog();
  });
  el('addForm').addEventListener('submit', (e)=>{
    e.preventDefault();
    const txt = el('addText').value.trim();
    if(!txt) return;
    const listId = el('addListSelect').value;
    addItem(txt, listId);
    el('addDialog').close();
    vibrate(16);
  });
  // Fix cancel/close so "required" nie blokuje
  el('addDlgClose').addEventListener('click', ()=> el('addDialog').close());
  el('addDlgCancel').addEventListener('click', ()=> el('addDialog').close());

  // Settings
  el('settingsBtn').addEventListener('click', ()=> el('settingsDialog').showModal());
  el('closeSettings').addEventListener('click', ()=> el('settingsDialog').close());
  el('darkModeToggle').addEventListener('change', (e)=>{ setTheme(e.target.checked); save(); });
  el('hideCompletedToggle').addEventListener('change', (e)=>{ state.settings.hideCompleted = !!e.target.checked; save(); render(); });
  el('vibrateToggle').addEventListener('change', (e)=>{ state.settings.vibrate = !!e.target.checked; save(); });

  // Print flow: choose list -> print -> restore view
  el('printBtn').addEventListener('click', ()=>{
    // Fill select
    const sel = el('printListSelect');
    sel.innerHTML = '';
    state.lists.forEach(l=>{
      const opt = document.createElement('option');
      opt.value = l.id; opt.textContent = l.name;
      sel.appendChild(opt);
    });
    const optC = document.createElement('option');
    optC.value = '__completed__';
    optC.textContent = 'Zakończone';
    sel.appendChild(optC);

    // Preselect current
    sel.value = state.currentListId === '__completed__' ? '__completed__' : (currentList()?.id || state.lists[0].id);
    el('printDialog').showModal();
  });
  el('printClose').addEventListener('click', ()=> el('printDialog').close());
  el('printCancel').addEventListener('click', ()=> el('printDialog').close());
  el('printForm').addEventListener('submit', (e)=>{
    e.preventDefault();
    const selected = el('printListSelect').value;
    const prev = state.currentListId;
    state.currentListId = selected;
    render();
    el('printDialog').close();
    const restore = ()=>{
      state.currentListId = prev;
      render();
      window.removeEventListener('afterprint', restore);
    };
    window.addEventListener('afterprint', restore);
    setTimeout(()=> window.print(), 50);
    // Fallback restore in case afterprint nie zadziała
    setTimeout(()=> restore(), 2000);
  });

  // Edit mode toggle (pencil)
  el('editModeBtn').addEventListener('click', ()=>{
    if(state.currentListId === '__completed__'){
      alert('Tryb edycji jest dostępny w konkretnej liście.');
      return;
    }
    state.editMode = !state.editMode;
    render();
  });

  // Close dialogs on backdrop click
  $$('dialog').forEach(d=>{
    d.addEventListener('click', (e)=>{
      const rect = d.getBoundingClientRect();
      const inDialog = e.clientX >= rect.left && e.clientX <= rect.right && e.clientY >= rect.top && e.clientY <= rect.bottom;
      if(!inDialog){ d.close(); }
    });
  });

  // Init
  load();
  setTheme(state.settings.dark);
  if(state.currentListId !== '__completed__' && !listById(state.currentListId)){
    state.currentListId = state.lists[0].id;
    state.lastActiveListId = state.currentListId;
  }
  render();
})();
</script>
</body>
</html>
