<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Smart Shop Planer 2.0</title>
    <style>
        :root {
            --primary: #0050aa;
            --accent: #e3000f;
            --bg: #f4f4f4;
            --surface: #ffffff;
            --text: #333333;
            --border: #dddddd;
            --path: #bbbbbb;
        }

        [data-theme="dark"] {
            --primary: #4dabf7;
            --accent: #ff6b6b;
            --bg: #121212;
            --surface: #1e1e1e;
            --text: #e0e0e0;
            --border: #333333;
            --path: #333333;
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0; padding: 0; background-color: var(--bg); color: var(--text);
            height: 100vh; display: flex; flex-direction: column; overflow: hidden;
            transition: background 0.3s, color 0.3s;
        }

        /* --- HEADER --- */
        header {
            background: var(--surface); color: var(--text); padding: 10px 15px;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid var(--border); z-index: 10;
        }
        h1 { margin: 0; font-size: 18px; font-weight: 800; background: linear-gradient(90deg, var(--primary), var(--accent)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        .header-controls { display: flex; gap: 10px; }
        .icon-btn { font-size: 20px; background: none; border: none; cursor: pointer; padding: 5px; }

        /* --- NAV --- */
        nav {
            background: var(--surface); padding: 8px 0; border-top: 1px solid var(--border);
            display: flex; justify-content: space-around; z-index: 9;
        }
        .nav-btn {
            background: none; border: none; color: #888; font-size: 11px; font-weight: bold;
            text-transform: uppercase; display: flex; flex-direction: column; align-items: center; gap: 4px; flex: 1;
        }
        .nav-btn.active { color: var(--primary); transform: scale(1.05); }
        .nav-btn .icon { font-size: 22px; }
        
        .badge {
            background: var(--accent); color: white; border-radius: 10px; padding: 2px 6px;
            font-size: 10px; position: absolute; margin-left: 15px; margin-top: -5px; display: none;
        }

        /* --- VIEWS --- */
        .view-section { flex: 1; overflow-y: auto; display: none; position: relative; scroll-behavior: smooth; }
        .view-section.active-view { display: block; }

        /* --- AISLE VIEW --- */
        #aisle-container {
            padding: 20px 10px 60px 10px; background: var(--bg);
            display: flex; flex-direction: column; gap: 6px; align-items: center;
        }

        /* Row Controls (Length) */
        .length-controls {
            display: flex; justify-content: center; gap: 20px; padding: 10px;
            background: var(--surface); border-bottom: 1px solid var(--border); width: 100%;
        }
        .len-btn {
            background: var(--bg); border: 1px solid var(--border); border-radius: 20px;
            padding: 5px 15px; font-weight: bold; font-size: 14px; color: var(--text);
        }

        .store-row {
            display: grid; grid-template-columns: 1fr 60px 1fr;
            width: 100%; max-width: 500px; height: 80px; align-items: center;
        }

        .path-center {
            height: 100%; background-color: var(--path);
            border-left: 2px dashed var(--bg); border-right: 2px dashed var(--bg);
            display: flex; justify-content: center; align-items: center; position: relative;
            border-radius: 4px;
        }
        
        .player {
            font-size: 30px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
            animation: moveCart 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 5;
        }
        @keyframes moveCart { from { transform: scale(0) translateY(20px); } to { transform: scale(1) translateY(0); } }

        .shelf-slot {
            height: 75px; background: var(--surface); border-radius: 10px; margin: 0 5px;
            border: 2px solid var(--border); display: flex; flex-direction: column;
            justify-content: center; align-items: center; font-size: 10px; color: #999;
            position: relative; overflow: hidden; transition: 0.2s;
        }
        .shelf-slot.filled {
            border: 2px solid var(--primary); color: var(--primary); font-weight: bold;
        }
        .shelf-slot .s-icon { font-size: 26px; margin-bottom: 2px; }
        
        /* Hold Animation */
        .hold-bar {
            position: absolute; bottom: 0; left: 0; height: 4px; background: var(--accent);
            width: 0%; transition: width 0.1s linear;
        }

        /* --- CHECKLIST --- */
        #checklist-container { padding: 15px; }
        .cl-group { background: var(--surface); border-radius: 10px; padding: 10px; margin-bottom: 15px; border: 1px solid var(--border); }
        .cl-title { font-size: 12px; font-weight: bold; color: var(--primary); text-transform: uppercase; margin-bottom: 8px; border-bottom: 1px solid var(--border); padding-bottom: 5px;}
        
        .cl-item {
            display: flex; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border);
            transition: all 0.2s;
        }
        .cl-item:last-child { border-bottom: none; }
        
        /* Solid Checkbox Logic */
        .cl-check-box {
            width: 24px; height: 24px; border: 2px solid #ccc; border-radius: 6px; margin-right: 10px;
            display: flex; align-items: center; justify-content: center; font-size: 16px; color: white;
            transition: 0.2s; flex-shrink: 0;
        }
        .cl-text { flex: 1; font-size: 16px; color: var(--text); }

        /* Checked State */
        .cl-item.is-checked .cl-check-box { background: var(--success); border-color: var(--success); }
        .cl-item.is-checked .cl-text { text-decoration: line-through; color: #aaa; }
        .cl-item.is-checked { opacity: 0.6; }

        /* --- MODALS --- */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); z-index: 2000; display: none;
            align-items: flex-end; justify-content: center;
        }
        .modal-content {
            background: var(--surface); width: 100%; max-width: 600px; max-height: 90vh;
            border-radius: 20px 20px 0 0; padding: 20px; display: flex; flex-direction: column;
            animation: slideUp 0.3s;
        }
        @keyframes slideUp { from { transform:translateY(100%); } to { transform:translateY(0); } }

        .prod-list { flex: 1; overflow-y: auto; margin-top: 10px; }
        .prod-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px; border-bottom: 1px solid var(--border);
        }
        .add-btn {
            width: 35px; height: 35px; border-radius: 50%; border: none; background: #eee;
            font-size: 20px; display: flex; align-items: center; justify-content: center;
        }
        .add-btn.added { background: var(--success); color: white; }

        /* Shelf Grid */
        .shelf-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; padding-bottom: 10px;}
        .shelf-btn {
            display: flex; flex-direction: column; align-items: center; padding: 10px;
            border: 1px solid var(--border); border-radius: 8px; background: var(--bg); color: var(--text); font-size: 11px;
        }
        
        /* New Category Form */
        #new-cat-form {
            background: var(--bg); padding: 10px; border-radius: 8px; margin-bottom: 10px; display: none;
        }

    </style>
</head>
<body data-theme="light">

    <header>
        <h1>Smart Shop 2.0</h1>
        <div class="header-controls">
            <button class="icon-btn" onclick="toggleTheme()">üåó</button>
            <button class="icon-btn" onclick="openTemplateModal()">üìÇ</button>
        </div>
    </header>

    <!-- CONTROLS FOR AISLE LENGTH -->
    <div id="aisle-controls" class="length-controls" style="display:none;">
        <span style="font-size:12px; display:flex; align-items:center; color:var(--text);">D≈Çugo≈õƒá sklepu:</span>
        <button class="len-btn" onclick="changeLength(-1)">‚ûñ Kr√≥tszy</button>
        <button class="len-btn" onclick="changeLength(1)">‚ûï D≈Çu≈ºszy</button>
    </div>

    <!-- VIEWS -->
    <div id="aisle-view" class="view-section active-view">
        <div id="aisle-container"></div>
    </div>

    <div id="checklist-view" class="view-section">
        <div id="checklist-container"></div>
    </div>

    <nav>
        <button class="nav-btn active" onclick="switchMode('plan')" id="nav-plan">
            <span class="icon">üè™</span><span>Sklep</span>
            <span id="badge-plan" class="badge">0</span>
        </button>
        <button class="nav-btn" onclick="switchMode('list')" id="nav-list">
            <span class="icon">‚úÖ</span><span>Lista</span>
            <span id="badge-list" class="badge">0</span>
        </button>
    </nav>

    <!-- MODAL PRODUKT√ìW -->
    <div id="prod-modal" class="modal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3 id="pm-title" style="margin:0;">Kategoria</h3>
                <button onclick="closeModal()" style="border:none; background:none; font-size:24px; color:var(--text)">&times;</button>
            </div>
            <div style="display:flex; gap:10px; margin-top:15px;">
                <input type="text" id="custom-input" placeholder="Wpisz nowy produkt..." style="flex:1; padding:10px; border:1px solid #ccc; border-radius:6px;">
                <button onclick="addCustomProduct()" style="background:var(--primary); color:white; border:none; border-radius:6px; width:40px; font-size:20px;">+</button>
            </div>
            <div id="pm-list" class="prod-list"></div>
        </div>
    </div>

    <!-- MODAL EDYCJI REGA≈ÅU -->
    <div id="edit-modal" class="modal">
        <div class="modal-content" style="height:85vh;">
            <h3 style="margin-top:0;">Wybierz Rega≈Ç</h3>
            
            <!-- Formularz nowej kategorii -->
            <button onclick="toggleNewCatForm()" style="width:100%; padding:10px; background:var(--primary); color:white; border:none; border-radius:6px; margin-bottom:10px;">‚ûï Stw√≥rz nowƒÖ kategoriƒô</button>
            
            <div id="new-cat-form">
                <div style="display:flex; gap:5px; margin-bottom:5px;">
                    <input type="text" id="new-cat-icon" placeholder="Ikona (np. üöó)" style="width:60px; text-align:center; padding:8px; border:1px solid #ccc; border-radius:4px;">
                    <input type="text" id="new-cat-name" placeholder="Nazwa (np. Auto)" style="flex:1; padding:8px; border:1px solid #ccc; border-radius:4px;">
                </div>
                <button onclick="saveNewCategory()" style="width:100%; background:var(--accent); color:white; border:none; padding:8px; border-radius:4px;">Zapisz i U≈ºyj</button>
            </div>

            <div style="overflow-y:auto; flex:1;">
                <div class="shelf-grid" id="shelf-grid"></div>
            </div>
            <button onclick="setShelf(null)" style="margin-top:10px; padding:12px; background:#ff6b6b; color:white; border:none; border-radius:8px;">üóë Usu≈Ñ Rega≈Ç</button>
        </div>
    </div>

    <!-- MODAL SZABLON√ìW -->
    <div id="tpl-modal" class="modal">
        <div class="modal-content" style="height:auto;">
            <h3>Zapisane Sklepy</h3>
            <div style="display:flex; gap:5px; margin-bottom:15px;">
                <input type="text" id="tpl-name" placeholder="Nazwa..." style="flex:1; padding:10px; border:1px solid #ccc; border-radius:6px;">
                <button onclick="saveTemplate()" style="background:var(--primary); color:white; border:none; padding:10px; border-radius:6px;">Zapisz</button>
            </div>
            <div id="tpl-list" style="max-height:200px; overflow-y:auto;"></div>
            <button onclick="closeModal()" style="margin-top:10px; padding:10px; background:#ddd; border:none; border-radius:6px;">Zamknij</button>
        </div>
    </div>

    <script>
        // --- STATE & DATA ---
        // Default Categories
        const DEFAULT_CATS = {
            "Pieczywo": {icon:"üçû", items:["Chleb", "Bu≈Çki", "Bagietka"]},
            "Warzywa": {icon:"ü•¶", items:["Ziemniaki", "Pomidory", "Og√≥rki"]},
            "Owoce": {icon:"üçé", items:["Banany", "Jab≈Çka", "Cytryny"]},
            "Nabia≈Ç": {icon:"ü•õ", items:["Mleko", "Mas≈Ço", "Ser"]},
            "Miƒôso": {icon:"ü•©", items:["Kurczak", "Szynka", "Kie≈Çbasa"]},
            "Napoje": {icon:"ü•§", items:["Woda", "Sok", "Cola"]},
            "S≈Çodycze": {icon:"üç´", items:["Czekolada", "Baton", "Ciastka"]},
            "Chemia": {icon:"üßº", items:["Papier", "P≈Çyn", "Proszek"]},
            "Mro≈ºonki": {icon:"üßä", items:["Frytki", "Pizza", "Lody"]},
            "≈öwiƒôta": {icon:"üéÖ", items:["Karp", "Op≈Çatek", "Barszcz"]},
            "Sylwester": {icon:"üéÜ", items:["Szampan", "Chipsy"]}
        };

        let storeLayout = [];
        let shoppingList = [];
        let categories = {}; // Will be loaded from LS or Default
        let editTarget = {row:0, side:'left'};
        let playerPos = -1;
        let holdTimer = null;

        // --- INIT ---
        function init() {
            // Load Categories from LocalStorage to allow persistence of new items/cats
            const savedCats = localStorage.getItem('shop_cats');
            if(savedCats) {
                categories = JSON.parse(savedCats);
            } else {
                categories = JSON.parse(JSON.stringify(DEFAULT_CATS));
            }

            // Init Store
            // Check if we have a temp layout or create new
            storeLayout = [];
            for(let i=0; i<20; i++) storeLayout.push({left:null, right:null});
            
            // Demo
            storeLayout[0].left = {cat:"WEJ≈öCIE", icon:"üö™", type:"entrance"};
            storeLayout[1].left = {cat:"Pieczywo", icon:"üçû"};
            storeLayout[1].right = {cat:"Nabia≈Ç", icon:"ü•õ"};
            storeLayout[19].right = {cat:"KASA", icon:"üí≥", type:"checkout"};

            renderStore();
            renderShelfGrid();
        }

        // --- CORE RENDERING ---
        function renderStore() {
            const container = document.getElementById('aisle-container');
            container.innerHTML = '';

            storeLayout.forEach((row, idx) => {
                const div = document.createElement('div');
                div.className = 'store-row';
                
                div.appendChild(createSlot(row.left, idx, 'left'));
                
                const path = document.createElement('div');
                path.className = 'path-center';
                if(idx === playerPos) path.innerHTML = '<div class="player">üõí</div>';
                div.appendChild(path);
                
                div.appendChild(createSlot(row.right, idx, 'right'));
                container.appendChild(div);
            });
        }

        function createSlot(data, r, side) {
            const el = document.createElement('div');
            el.className = 'shelf-slot';
            if(data) {
                el.classList.add('filled');
                if(data.type) el.style.borderColor = data.type === 'entrance' ? '#28a745' : '#ffc107';
                el.innerHTML = `
                    <span class="s-icon">${data.icon}</span>
                    <span>${data.cat}</span>
                    <div class="hold-bar"></div>
                `;
            } else {
                el.innerHTML = `<span style="font-size:20px; opacity:0.2;">+</span>`;
            }

            // Interaction Logic
            const startHold = () => {
                const bar = el.querySelector('.hold-bar');
                if(bar) bar.style.width = '100%';
                holdTimer = setTimeout(() => {
                    if(bar) bar.style.width = '0%';
                    // Open Edit
                    editTarget = {row:r, side:side};
                    document.getElementById('new-cat-form').style.display = 'none'; // Reset form
                    document.getElementById('edit-modal').style.display = 'flex';
                }, 600); // 600ms hold
            };

            const endHold = () => {
                clearTimeout(holdTimer);
                const bar = el.querySelector('.hold-bar');
                if(bar) bar.style.width = '0%';
            };

            // Touch events
            el.addEventListener('touchstart', startHold);
            el.addEventListener('touchend', endHold);
            el.addEventListener('mousedown', startHold);
            el.addEventListener('mouseup', endHold);

            el.onclick = () => {
                clearTimeout(holdTimer); // Ensure click doesn't trigger hold
                if(!data) {
                    // Empty -> Edit
                    editTarget = {row:r, side:side};
                    document.getElementById('edit-modal').style.display = 'flex';
                } else if(!data.type) {
                    // Filled Shelf -> Open Products & Move Cart
                    playerPos = r;
                    renderStore();
                    el.scrollIntoView({behavior:'smooth', block:'center'});
                    setTimeout(() => openProducts(data.cat), 200);
                }
            };

            return el;
        }

        // --- PRODUCT LOGIC ---
        function openProducts(catName) {
            document.getElementById('pm-title').innerText = catName;
            const list = document.getElementById('pm-list');
            list.innerHTML = '';
            
            // Get items from our dynamic categories
            const items = categories[catName]?.items || [];
            
            items.forEach(item => {
                const row = document.createElement('div');
                row.className = 'prod-row';
                row.innerHTML = `<span>${item}</span>`;
                
                const btn = document.createElement('button');
                btn.className = 'add-btn';
                
                if(shoppingList.some(i => i.name === item)) {
                    btn.classList.add('added');
                    btn.innerText = '‚úî';
                } else {
                    btn.innerText = '+';
                }

                btn.onclick = () => toggleProduct(item, catName, btn);
                row.appendChild(btn);
                list.appendChild(row);
            });
            document.getElementById('prod-modal').style.display = 'flex';
        }

        function toggleProduct(name, cat, btn) {
            const idx = shoppingList.findIndex(i => i.name === name);
            if(idx > -1) {
                shoppingList.splice(idx, 1);
                btn.classList.remove('added');
                btn.innerText = '+';
            } else {
                shoppingList.push({name, cat, checked:false});
                btn.classList.add('added');
                btn.innerText = '‚úî';
            }
            updateBadge();
        }

        // --- KEY FEATURE: SAVE CUSTOM PRODUCT ---
        function addCustomProduct() {
            const inp = document.getElementById('custom-input');
            const val = inp.value.trim();
            const cat = document.getElementById('pm-title').innerText;

            if(val && categories[cat]) {
                // 1. Add to shopping list
                shoppingList.push({name: val, cat, checked: false});
                
                // 2. Add to Category Memory if not exists
                if(!categories[cat].items.includes(val)) {
                    categories[cat].items.push(val);
                    saveCategories(); // Persist to LS
                }

                inp.value = '';
                updateBadge();
                // Refresh view to show it added
                openProducts(cat);
            }
        }

        // --- KEY FEATURE: CHECKLIST LOGIC ---
        function renderChecklist() {
            const container = document.getElementById('checklist-container');
            container.innerHTML = '';

            if(shoppingList.length === 0) {
                container.innerHTML = '<div style="text-align:center; margin-top:50px; opacity:0.5;">Koszyk pusty</div>';
                return;
            }

            // Group by Category
            const grouped = {};
            shoppingList.forEach((item, i) => {
                if(!grouped[item.cat]) grouped[item.cat] = [];
                grouped[item.cat].push({...item, idx: i});
            });

            for(const cat in grouped) {
                const grp = document.createElement('div');
                grp.className = 'cl-group';
                
                const title = document.createElement('div');
                title.className = 'cl-title';
                title.innerText = cat;
                grp.appendChild(title);

                grouped[cat].forEach(item => {
                    const row = document.createElement('div');
                    row.className = 'cl-item' + (item.checked ? ' is-checked' : '');
                    
                    // Checkbox visual
                    const check = document.createElement('div');
                    check.className = 'cl-check-box';
                    if(item.checked) check.innerText = '‚úî';

                    const text = document.createElement('div');
                    text.className = 'cl-text';
                    text.innerText = item.name;

                    const delBtn = document.createElement('button');
                    delBtn.innerHTML = 'üóë';
                    delBtn.style.border='none'; delBtn.style.background='none'; delBtn.style.marginLeft='10px';
                    delBtn.onclick = (e) => {
                        e.stopPropagation();
                        shoppingList.splice(item.idx, 1);
                        renderChecklist();
                        updateBadge();
                    };

                    row.appendChild(check);
                    row.appendChild(text);
                    row.appendChild(delBtn);

                    // Toggle Logic
                    row.onclick = () => {
                        shoppingList[item.idx].checked = !shoppingList[item.idx].checked;
                        renderChecklist();
                        updateBadge();
                    };

                    grp.appendChild(row);
                });
                container.appendChild(grp);
            }
        }

        // --- SHELF EDITING & CREATION ---
        function renderShelfGrid() {
            const grid = document.getElementById('shelf-grid');
            grid.innerHTML = '';
            
            // Specials
            const specials = [
                {n:"WEJ≈öCIE", i:"üö™", t:"entrance", c:"#28a745"},
                {n:"KASA", i:"üí≥", t:"checkout", c:"#ffc107"}
            ];
            specials.forEach(s => {
                const btn = document.createElement('button');
                btn.className = 'shelf-btn';
                btn.style.borderColor = s.c;
                btn.innerHTML = `<span style="font-size:20px">${s.i}</span><b>${s.n}</b>`;
                btn.onclick = () => setShelf(s.n, s.i, s.t);
                grid.appendChild(btn);
            });

            // Categories from Object
            Object.keys(categories).forEach(cat => {
                const btn = document.createElement('button');
                btn.className = 'shelf-btn';
                btn.innerHTML = `<span style="font-size:20px">${categories[cat].icon}</span><span>${cat}</span>`;
                btn.onclick = () => setShelf(cat, categories[cat].icon);
                grid.appendChild(btn);
            });
        }

        function toggleNewCatForm() {
            const f = document.getElementById('new-cat-form');
            f.style.display = f.style.display === 'block' ? 'none' : 'block';
        }

        function saveNewCategory() {
            const name = document.getElementById('new-cat-name').value.trim();
            const icon = document.getElementById('new-cat-icon').value.trim() || 'üì¶';
            
            if(name) {
                // Add to memory
                categories[name] = { icon: icon, items: [] };
                saveCategories(); // Persist
                
                // Refresh Grid
                renderShelfGrid();
                
                // Select immediately
                setShelf(name, icon);
                
                // Reset form
                document.getElementById('new-cat-name').value = '';
                document.getElementById('new-cat-icon').value = '';
                document.getElementById('new-cat-form').style.display = 'none';
            }
        }

        function setShelf(cat, icon, type=null) {
            const {row, side} = editTarget;
            if(cat === null) storeLayout[row][side] = null;
            else storeLayout[row][side] = {cat, icon, type};
            closeModal();
            renderStore();
        }

        // --- STORE LENGTH ---
        function changeLength(delta) {
            if(delta === 1) {
                storeLayout.push({left:null, right:null});
            } else {
                if(storeLayout.length > 5) storeLayout.pop(); // Minimum 5 rows
                else alert("Sklep nie mo≈ºe byƒá kr√≥tszy!");
            }
            renderStore();
        }

        // --- SYSTEM ---
        function saveCategories() {
            localStorage.setItem('shop_cats', JSON.stringify(categories));
        }

        function updateBadge() {
            const n = shoppingList.filter(i => !i.checked).length;
            document.querySelectorAll('.badge').forEach(b => {
                b.innerText = n;
                b.style.display = n > 0 ? 'inline-block' : 'none';
            });
        }

        function switchMode(m) {
            document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active-view'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            
            if(m === 'plan') {
                document.getElementById('aisle-view').classList.add('active-view');
                document.getElementById('aisle-controls').style.display = 'flex'; // Show length controls
                document.getElementById('nav-plan').classList.add('active');
            } else {
                document.getElementById('checklist-view').classList.add('active-view');
                document.getElementById('aisle-controls').style.display = 'none';
                document.getElementById('nav-list').classList.add('active');
                renderChecklist();
            }
        }

        function toggleTheme() {
            const b = document.body;
            b.setAttribute('data-theme', b.getAttribute('data-theme')==='light'?'dark':'light');
        }

        function openTemplateModal() { document.getElementById('tpl-modal').style.display='flex'; loadTemplates(); }
        function closeModal() { document.querySelectorAll('.modal').forEach(m=>m.style.display='none'); }

        // Template logic
        function saveTemplate() {
            const name = document.getElementById('tpl-name').value;
            if(name) {
                const db = JSON.parse(localStorage.getItem('layouts') || '{}');
                db[name] = storeLayout;
                localStorage.setItem('layouts', JSON.stringify(db));
                loadTemplates();
                document.getElementById('tpl-name').value = '';
            }
        }
        function loadTemplates() {
            const list = document.getElementById('tpl-list');
            list.innerHTML = '';
            const db = JSON.parse(localStorage.getItem('layouts') || '{}');
            Object.keys(db).forEach(k => {
                const d = document.createElement('div');
                d.style.borderBottom='1px solid #ccc'; d.style.padding='10px'; d.style.display='flex'; d.style.justifyContent='space-between';
                d.innerHTML = `<span>${k}</span>`;
                const b = document.createElement('button'); b.innerText='Wczytaj';
                b.onclick = ()=>{ storeLayout=db[k]; renderStore(); closeModal(); };
                d.appendChild(b);
                list.appendChild(d);
            });
        }

        init();
    </script>
</body>
</html>
